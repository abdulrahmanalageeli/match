import { useState, useEffect, useMemo, useRef } from "react";
import { 
  Clock, 
  Users, 
  Play, 
  Pause, 
  SkipForward, 
  ChevronRight, 
  ChevronLeft,
  ChevronDown,
  HelpCircle,
  Trophy,
  Star,
  Heart,
  Zap,
  Target,
  Smile,
  ThumbsUp,
  MessageSquare,
  Sparkles,
  Plus,
  Trash2,
  BookOpen,
  Lightbulb,
  Home,
  Timer,
  CheckCircle,
  XCircle,
  Rocket,
  PartyPopper,
  Ghost,
  Lock
} from "lucide-react";
import { Button } from "../../components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "../../components/ui/card";
import { Badge } from "../../components/ui/badge";
import { Progress } from "../../components/ui/progress";
import { Smartphone, Link as LinkIcon, Bell } from "lucide-react";
import PromptTopicsModal from "../components/PromptTopicsModal";
import { OnboardingModal } from "../components/groups/OnboardingModal";
import PhoneEntry from "../components/groups/PhoneEntry";
import logoPng from "../welcome/blindmatch.png";
import { animate } from "motion";

// Logo Component for Groups Page - Removed (now integrated into header)

interface Game {
  id: string;
  name: string;
  nameAr: string;
  description: string;
  descriptionAr: string;
  duration: number; // in minutes
  icon: JSX.Element;
  color: string;
}

const games: Game[] = [
  {
    id: "discussion-questions",
    name: "Discussion Questions",
    nameAr: "أسئلة للنقاش",
    description: "Deep conversation starters",
    descriptionAr: "أسئلة عميقة لبدء المحادثات",
    duration: 10,
    icon: <Sparkles className="w-6 h-6" />,
    color: "from-purple-500 to-pink-500"
  },
  {
    id: "what-would-you-do",
    name: "What Would You Do",
    nameAr: "ماذا تفعل لو",
    description: "Medium-to-deep real-life scenarios for value-driven discussion",
    descriptionAr: "سيناريوهات حياتية متوسطة إلى عميقة تفتح نقاشاً حول القيم والقرارات",
    duration: 10,
    icon: <MessageSquare className="w-6 h-6" />,
    color: "from-indigo-500 to-blue-600"
  },
  {
    id: "5-second-rule",
    name: "5-Second Rule",
    nameAr: "قاعدة الخمس ثواني",
    description: "Name 3 things in 5 seconds",
    descriptionAr: "سمّ 3 أشياء في 5 ثواني",
    duration: 10,
    icon: <Timer className="w-6 h-6" />,
    color: "from-orange-500 to-red-500"
  },
  {
    id: "charades",
    name: "Wala Kelma",
    nameAr: "ولا كلمة",
    description: "Act out fun pop culture topics without speaking",
    descriptionAr: "مثلوا مواضيع ممتعة ومشهورة بدون كلام",
    duration: 10,
    icon: <ThumbsUp className="w-6 h-6" />,
    color: "from-green-500 to-teal-500"
  },
  {
    id: "never-have-i-ever",
    name: "Never Have I Ever",
    nameAr: "لم أفعل من قبل",
    description: "Share deep personal experiences",
    descriptionAr: "شاركوا تجاربكم الشخصية العميقة",
    duration: 10,
    icon: <Target className="w-6 h-6" />,
    color: "from-blue-500 to-cyan-500"
  },
  {
    id: "would-you-rather",
    name: "Would You Rather",
    nameAr: "ماذا تفضل",
    description: "Choose between meaningful life decisions",
    descriptionAr: "اختاروا بين قرارات حياتية مهمة",
    duration: 10,
    icon: <Heart className="w-6 h-6" />,
    color: "from-red-500 to-orange-500"
  }
];

// Append Imposter game as the 7th option
games.push({
  id: "imposter",
  name: "Imposter",
  nameAr: "الأمبوستر",
  description: "Social deduction party game on one phone",
  descriptionAr: "لعبة تخمين جماعية على هاتف واحد: كلمة سرية ومحتال يحاول التخفي",
  duration: 12,
  icon: <Ghost className="w-6 h-6" />,
  color: "from-fuchsia-600 to-purple-700"
})

// Premium visual themes per game for selection cards + gameplay surfaces
const gameThemes: Record<string, {
  // Selection card accents
  cardBorder: string;
  cardBorderHover: string;
  cardOverlay: string;
  iconRing: string;
  chip: string;
  metaText: string;
  cta: string;
  // Gameplay accents
  instruction: string;
  promptCard?: string;
  optionA?: string;
  optionB?: string;
  scorePill?: string;
}> = {
  default: {
    cardBorder: "border-slate-700/50",
    cardBorderHover: "hover:border-slate-500/60",
    cardOverlay: "from-white/5 via-transparent to-transparent",
    iconRing: "ring-1 ring-white/10",
    chip: "bg-slate-700/40 border border-white/10 text-slate-200",
    metaText: "text-slate-300",
    cta: "from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800",
    instruction: "bg-slate-700/30 rounded-xl p-6 border border-slate-600/50",
  },
  'what-would-you-do': {
    cardBorder: "border-indigo-600/30",
    cardBorderHover: "hover:border-indigo-400/60",
    cardOverlay: "from-indigo-500/15 via-blue-500/10 to-transparent",
    iconRing: "ring-2 ring-indigo-400/40",
    chip: "bg-indigo-500/20 border border-indigo-400/30 text-indigo-100",
    metaText: "text-indigo-200",
    cta: "from-indigo-600 to-blue-700 hover:from-indigo-700 hover:to-blue-800",
    instruction: "bg-gradient-to-r from-indigo-700/40 to-blue-700/40 rounded-xl p-6 border border-indigo-600/50",
    promptCard: "bg-gradient-to-r from-indigo-500/20 to-blue-500/20 border-2 border-indigo-500/40 rounded-2xl p-8 text-center shadow-2xl",
  },
  '5-second-rule': {
    cardBorder: "border-orange-600/30",
    cardBorderHover: "hover:border-orange-400/60",
    cardOverlay: "from-orange-500/15 via-red-500/10 to-transparent",
    iconRing: "ring-2 ring-orange-400/40",
    chip: "bg-orange-500/20 border border-orange-400/30 text-orange-100",
    metaText: "text-orange-200",
    cta: "from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700",
    instruction: "bg-gradient-to-r from-orange-700/40 to-red-700/40 rounded-xl p-6 border border-orange-600/50",
    scorePill: "bg-gradient-to-r from-orange-700/50 to-red-700/50 rounded-xl px-6 py-3 border border-orange-500/30",
  },
  'charades': {
    cardBorder: "border-emerald-600/30",
    cardBorderHover: "hover:border-emerald-400/60",
    cardOverlay: "from-emerald-500/15 via-teal-500/10 to-transparent",
    iconRing: "ring-2 ring-emerald-400/40",
    chip: "bg-emerald-500/20 border border-emerald-400/30 text-emerald-100",
    metaText: "text-emerald-200",
    cta: "from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700",
    instruction: "bg-gradient-to-r from-slate-700/40 to-slate-600/40 rounded-xl p-6 border border-slate-600/50",
  },
  'never-have-i-ever': {
    cardBorder: "border-violet-600/30",
    cardBorderHover: "hover:border-violet-400/60",
    cardOverlay: "from-violet-500/15 via-fuchsia-500/10 to-transparent",
    iconRing: "ring-2 ring-violet-400/40",
    chip: "bg-violet-500/20 border border-violet-400/30 text-violet-100",
    metaText: "text-violet-200",
    cta: "from-violet-600 to-fuchsia-600 hover:from-violet-700 hover:to-fuchsia-700",
    instruction: "bg-gradient-to-r from-slate-700/40 to-slate-600/40 rounded-xl p-6 border border-slate-600/50",
    promptCard: "bg-slate-700/50 rounded-2xl p-6 text-center border border-slate-600/60",
  },
  'would-you-rather': {
    cardBorder: "border-rose-600/30",
    cardBorderHover: "hover:border-rose-400/60",
    cardOverlay: "from-rose-500/15 via-blue-500/10 to-transparent",
    iconRing: "ring-2 ring-rose-400/40",
    chip: "bg-rose-500/20 border border-rose-400/30 text-rose-100",
    metaText: "text-rose-200",
    cta: "from-rose-600 to-red-700 hover:from-rose-700 hover:to-red-800",
    instruction: "bg-slate-700/30 rounded-xl p-6 border border-slate-600/50",
    optionA: "bg-gradient-to-br from-rose-500/15 to-red-600/10 border-2 border-rose-500/40 rounded-xl p-5 text-center shadow-lg",
    optionB: "bg-gradient-to-br from-sky-500/15 to-blue-600/10 border-2 border-sky-500/40 rounded-xl p-5 text-center shadow-lg",
  },
  'discussion-questions': {
    cardBorder: "border-cyan-600/30",
    cardBorderHover: "hover:border-cyan-400/60",
    cardOverlay: "from-cyan-500/15 via-blue-500/10 to-transparent",
    iconRing: "ring-2 ring-cyan-400/40",
    chip: "bg-cyan-500/20 border border-cyan-400/30 text-cyan-100",
    metaText: "text-cyan-200",
    cta: "from-cyan-600 to-blue-700 hover:from-cyan-700 hover:to-blue-800",
    instruction: "bg-slate-700/30 rounded-xl p-6 border border-slate-600/50",
  },
  'imposter': {
    cardBorder: "border-fuchsia-600/30",
    cardBorderHover: "hover:border-fuchsia-400/60",
    cardOverlay: "from-fuchsia-500/15 via-purple-500/10 to-transparent",
    iconRing: "ring-2 ring-fuchsia-400/40",
    chip: "bg-fuchsia-500/20 border border-fuchsia-400/30 text-fuchsia-100",
    metaText: "text-fuchsia-200",
    cta: "from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800",
    instruction: "bg-gradient-to-r from-fuchsia-700/30 to-purple-700/30 rounded-xl p-6 border border-fuchsia-600/40",
    promptCard: "bg-gradient-to-br from-fuchsia-500/15 to-purple-600/15 rounded-2xl p-6 text-center border border-fuchsia-500/30 shadow-xl",
  },
};


const neverHaveIEverQuestions = [
  // Original 50 questions
  "لم أفعل من قبل: غيرت مساري المهني أو الدراسي بشكل جذري",
  "لم أفعل من قبل: سافرت لوحدي لبلد لا أعرف فيه أحد",
  "لم أفعل من قبل: اتخذت قراراً مهماً ضد رأي عائلتي وكان صحيحاً",
  "لم أفعل من قبل: تعلمت مهارة جديدة تماماً بعد سن الـ25",
  "لم أفعل من قبل: واجهت موقفاً خطيراً وتصرفت بشجاعة",
  "لم أفعل من قبل: قابلت شخصاً غريباً أثر في حياتي بشكل كبير",
  "لم أفعل من قبل: ضحيت بفرصة ذهبية من أجل شخص أحبه",
  "لم أفعل من قبل: اكتشفت موهبة عندي بالصدفة",
  "لم أفعل من قبل: عشت تجربة غيرت نظرتي للحياة تماماً",
  "لم أفعل من قبل: واجهت خوفاً كبيراً وتغلبت عليه",
  "لم أفعل من قبل: قطعت علاقة سامة رغم صعوبة القرار",
  "لم أفعل من قبل: ساعدت شخصاً غريباً في أزمة حقيقية",
  "لم أفعل من قبل: تجاهلت نصيحة الجميع واتبعت حدسي ونجحت",
  "لم أفعل من قبل: عشت لحظة شعرت فيها أني في المكان الصحيح تماماً",
  "لم أفعل من قبل: اكتشفت حقيقة مؤلمة عن شخص قريب مني",
  "لم أفعل من قبل: غيرت رأيي في قناعة كنت متمسكاً فيها لسنوات",
  "لم أفعل من قبل: عشت تجربة روحانية عميقة في الحج أو العمرة",
  "لم أفعل من قبل: تعرضت لموقف ظلم وقفت ضده رغم الثمن",
  "لم أفعل من قبل: اكتشفت شغفاً حقيقياً غير مجال عملي",
  "لم أفعل من قبل: عشت لحظة فخر حقيقي بإنجاز حققته بنفسي",
  "لم أفعل من قبل: كنت في موقف خطير وتصرفت بطريقة لم أتوقعها من نفسي",
  "لم أفعل من قبل: قابلت شخص مشهور أو مؤثر وكان الموقف غريباً أو مضحكاً",
  "لم أفعل من قبل: وقعت في موقف محرج جداً أمام مجموعة كبيرة من الناس",
  "لم أفعل من قبل: أنقذت شخصاً من موقف صعب أو خطير",
  "لم أفعل من قبل: تورطت في مشكلة كبيرة بسبب سوء فهم",
  "لم أفعل من قبل: ضعت في مكان غريب ولم أعرف كيف أرجع",
  "لم أفعل من قبل: شهدت حادثة غريبة جداً لا أحد يصدقها عندما أرويها",
  "لم أفعل من قبل: اكتشفت سراً كبيراً عن شخص قريب مني بالصدفة",
  "لم أفعل من قبل: تعرضت لموقف خارق للطبيعة أو غريب جداً لا أستطيع تفسيره",
  "لم أفعل من قبل: قمت بمغامرة جنونية ندمت عليها في منتصفها",
  "لم أفعل من قبل: واجهت شخصاً ظالماً أو متنمراً ووقفت في وجهه",
  "لم أفعل من قبل: عشت تجربة سفر كارثية تحولت لذكرى مضحكة",
  "لم أفعل من قبل: اكتشفت موهبة مخفية عندي في موقف غير متوقع",
  "لم أفعل من قبل: تسببت في موقف فوضوي كبير بدون قصد",
  "لم أفعل من قبل: نجوت من موقف كان ممكن ينتهي بشكل سيء جداً",
  "لم أفعل من قبل: قابلت شخصاً غيّر طريقة تفكيري في لقاء واحد فقط",
  "لم أفعل من قبل: عشت تجربة رعب حقيقية في مكان مهجور أو مخيف",
  "لم أفعل من قبل: اكتشفت خيانة أو كذبة كبيرة بطريقة درامية",
  "لم أفعل من قبل: قمت بشيء شجاع جداً رغم خوفي الشديد",
  "لم أفعل من قبل: تعرضت لموقف طريف جداً في مكان رسمي أو مهم",
  "لم أفعل من قبل: ساعدت شخصاً غريباً وتحول لصديق مقرب",
  "لم أفعل من قبل: عشت تجربة غريبة أو مرعبة في الطيران أو السفر",
  "لم أفعل من قبل: اتخذت قراراً متهوراً غيّر حياتي للأفضل",
  "لم أفعل من قبل: تعرضت لموقف سوء تفاهم كبير مع السلطات أو الشرطة",
  "لم أفعل من قبل: اكتشفت مكاناً سرياً أو مخفياً بالصدفة",
  "لم أفعل من قبل: عشت لحظة بطولية أنقذت فيها موقفاً صعباً",
  "لم أفعل من قبل: تعرضت لموقف كوميدي في أسوأ توقيت ممكن",
  "لم أفعل من قبل: واجهت مخاوفي وقمت بشيء كنت أخاف منه لسنوات",
  "لم أفعل من قبل: عشت تجربة غريبة أو خطيرة مع حيوان في الطبيعة",
  
  // NEW 50 engaging questions
  "لم أفعل من قبل: بكيت من السعادة في لحظة غير متوقعة أبداً",
  "لم أفعل من قبل: اكتشفت أن شخصاً كان يكذب علي لسنوات طويلة",
  "لم أفعل من قبل: قضيت ليلة كاملة في مكان عام بسبب ظرف طارئ",
  "لم أفعل من قبل: تظاهرت بأني شخص آخر في موقف اجتماعي",
  "لم أفعل من قبل: غيرت رأيي في شخص تماماً بعد موقف واحد فقط",
  "لم أفعل من قبل: اكتشفت أن لدي قريب أو أخ لم أكن أعرف بوجوده",
  "لم أفعل من قبل: عشت تجربة ديجافو قوية جداً غيرت قناعاتي",
  "لم أفعل من قبل: أنقذني شخص غريب من موقف خطير أو محرج",
  "لم أفعل من قبل: اكتشفت موهبة فنية عندي في سن متأخرة",
  "لم أفعل من قبل: تعرضت لموقف جعلني أعيد التفكير في كل شيء في حياتي",
  "لم أفعل من قبل: قابلت شخصاً في الواقع بعد صداقة طويلة على الإنترنت",
  "لم أفعل من قبل: شاركت في عمل تطوعي أو مبادرة مجتمعية لقضية أؤمن بها",
  "لم أفعل من قبل: عشت تجربة حب من طرف واحد استمرت لسنوات",
  "لم أفعل من قبل: اكتشفت أن صديقاً مقرباً كان يحسدني أو يغار مني",
  "لم أفعل من قبل: تعرضت لحادث سيارة أو موقف مروري خطير",
  "لم أفعل من قبل: فقدت شيئاً ثميناً جداً ولم أجده أبداً",
  "لم أفعل من قبل: قمت بعمل خيري غيّر حياة شخص بشكل جذري",
  "لم أفعل من قبل: تعلمت لغة جديدة بشكل ذاتي وأتقنتها",
  "لم أفعل من قبل: عشت في مدينة أو بلد مختلف لأكثر من 6 أشهر",
  "لم أفعل من قبل: اكتشفت أن لدي حساسية أو مرض لم أكن أعرفه",
  "لم أفعل من قبل: قطعت وعداً مهماً لنفسي ونفذته فعلاً",
  "لم أفعل من قبل: تعرضت لموقف تمييز أو عنصرية واضح",
  "لم أفعل من قبل: فزت بجائزة أو مسابقة مهمة في حياتي",
  "لم أفعل من قبل: قضيت أكثر من أسبوع بدون إنترنت أو هاتف",
  "لم أفعل من قبل: اكتشفت أن شخصاً كان يتحدث عني بالسوء خلف ظهري",
  "لم أفعل من قبل: عشت تجربة فقدان شخص عزيز غيرت نظرتي للحياة",
  "لم أفعل من قبل: قمت بشيء متهور في لحظة غضب وندمت عليه",
  "لم أفعل من قبل: تعرضت لموقف سرقة أو نصب واضح",
  "لم أفعل من قبل: اكتشفت شغفاً جديداً بعد سن الثلاثين",
  "لم أفعل من قبل: عشت تجربة صداقة انتهت بشكل مفاجئ ومؤلم",
  "لم أفعل من قبل: قمت بمواجهة شخص بحقيقة مؤلمة عنه",
  "لم أفعل من قبل: تعرضت لموقف طبي طارئ أنقذ حياتي",
  "لم أفعل من قبل: اكتشفت أن لدي قدرة أو مهارة نادرة",
  "لم أفعل من قبل: عشت تجربة حزن عميق جعلتني أقوى",
  "لم أفعل من قبل: قمت بتغيير جذري في مظهري أو أسلوبي",
  "لم أفعل من قبل: تعرضت لموقف جعلني أفقد الثقة في الناس لفترة",
  "لم أفعل من قبل: اكتشفت أن لدي خوف أو فوبيا لم أكن أعرفها",
  "لم أفعل من قبل: عشت تجربة نجاح كبير بعد فشل متكرر",
  "لم أفعل من قبل: قمت بقطع علاقة مع أحد أفراد العائلة",
  "لم أفعل من قبل: تعرضت لموقف جعلني أعيد تقييم أولوياتي بالكامل",
  "لم أفعل من قبل: اكتشفت أن شخصاً كان يحبني وأنا لم أكن أعلم",
  "لم أفعل من قبل: عشت تجربة وحدة عميقة علمتني الكثير عن نفسي",
  "لم أفعل من قبل: قمت بمغامرة مالية كبيرة ونجحت أو فشلت فيها",
  "لم أفعل من قبل: تعرضت لموقف جعلني أقدر نعمة الصحة",
  "لم أفعل من قبل: اكتشفت سر عائلي كبير غير نظرتي لأشياء كثيرة",
  "لم أفعل من قبل: عشت تجربة صدمة ثقافية في بلد أجنبي",
  "لم أفعل من قبل: قمت بمسامحة شخص أساء لي بشكل كبير",
  "لم أفعل من قبل: تعرضت لموقف جعلني أدرك قيمة الوقت",
  "لم أفعل من قبل: اكتشفت أن لدي قدرة على التأثير في الآخرين",
  "لم أفعل من قبل: عشت لحظة استسلام كامل ثم نهضت من جديد",
  "لم أفعل من قبل: رفضت ترقية مغرية لأن قيمها لا تناسبني",
  "لم أفعل من قبل: قلت 'لا' لواسطة حتى لو خسرت فرصة كبيرة",
  "لم أفعل من قبل: اعتذرت علناً عن خطأ ارتكبته على مواقع التواصل",
  "لم أفعل من قبل: توليت رعاية أحد أفراد العائلة لفترة طويلة",
  "لم أفعل من قبل: نظّمت فعالية مجتمعية من الصفر",
  "لم أفعل من قبل: علّمت شخصاً مهارة غيرت مساره",
  "لم أفعل من قبل: قضيت شهراً كاملاً بلا سوشيال ميديا",
  "لم أفعل من قبل: عشت تجربة تخييم في الصحراء لليلة كاملة",
  "لم أفعل من قبل: كتبت مقالاً أو منشوراً انتشر على نطاق واسع",
  "لم أفعل من قبل: واجهت مديري بموضوع أخلاقي حساس",
  "لم أفعل من قبل: أنقذت علاقة صداقة بعد خلاف عميق",
  "لم أفعل من قبل: قُدت فريقاً خلال أزمة حقيقية ونجونا",
  "لم أفعل من قبل: تبرعت سراً لشخص محتاج دون أن يعرفني",
  "لم أفعل من قبل: غيّرت عادة سيئة استمرت سنوات",
  "لم أفعل من قبل: كوّنت صداقة عميقة مع شخص من جيل مختلف",
  "لم أفعل من قبل: شاركت في سباق أو تحدٍ رياضي قاسٍ",
  "لم أفعل من قبل: تعلمت العزف على آلة موسيقية من الصفر",
  "لم أفعل من قبل: اتخذت إجازة سبتية لإعادة ترتيب حياتي",
  "لم أفعل من قبل: خرجت من منطقة الراحة لمدة 30 يوماً متتالية",
  "لم أفعل من قبل: قُدت مبادرة في العمل بدون صلاحيات رسمية",
  "لم أفعل من قبل: تعاملت بهدوء مع إساءة علنية وتعلمت منها",
  "لم أفعل من قبل: بنيت عادة قراءة يومية واستمرّت 100 يوم",
  "لم أفعل من قبل: تعلّمت السباحة رغم خوفي القديم من الماء",
  "لم أفعل من قبل: صلّحت علاقة عائلية انقطعت لسنوات",
  "لم أفعل من قبل: قلت 'لا أعلم' في موقف يُنتظر مني الإجابة",
  "لم أفعل من قبل: غيّرت رأيي علناً بعد الاطلاع على حقائق جديدة",
  "لم أفعل من قبل: تطوّعت بمهارتي المهنية لصالح جهة خيرية",
  "لم أفعل من قبل: تركت مجموعة أو بيئة سامة رغم الضغوط",
  "لم أفعل من قبل: واجهت خوف التحدث أمام جمهور كبير بنجاح",
  "لم أفعل من قبل: استعنت بمعالج أو مستشار لتحسين صحتي النفسية"
];

const wouldYouRatherQuestions = [
  {
    optionA: "أن تعمل في وظيفة تحبها براتب قليل",
    optionB: "أن تعمل في وظيفة تكرهها براتب ضخم"
  },
  {
    optionA: "أن تعيش في السعودية مع عائلتك",
    optionB: "أن تعيش في أوروبا مع فرص أفضل ولكن بعيداً عن الأهل"
  },
  {
    optionA: "أن تبدأ مشروعك الخاص بمخاطرة عالية",
    optionB: "أن تبقى في وظيفة مستقرة ولكن بدون نمو"
  },
  {
    optionA: "أن تتزوج شخصاً تحبه ولكن عائلتك ضده",
    optionB: "أن تتزوج شخصاً ترضى عنه العائلة ولكن لا تحبه"
  },
  {
    optionA: "أن تعرف الحقيقة المؤلمة",
    optionB: "أن تعيش في جهل مريح"
  },
  {
    optionA: "أن تسافر حول العالم لمدة سنة بدون عمل",
    optionB: "أن تعمل بجد لمدة سنة وتشتري بيت أحلامك"
  },
  {
    optionA: "أن تكون مشهوراً في مجالك ولكن بدون خصوصية",
    optionB: "أن تكون ناجحاً بصمت مع حياة خاصة هادئة"
  },
  {
    optionA: "أن تعيش 100 سنة بصحة متوسطة",
    optionB: "أن تعيش 60 سنة بصحة ممتازة"
  },
  {
    optionA: "أن تكون قادراً على قراءة الأفكار",
    optionB: "أن تكون قادراً على التحدث بكل اللغات"
  },
  {
    optionA: "أن تعيش في الرياض مع فرص عمل أكثر",
    optionB: "أن تعيش في جدة مع جودة حياة أفضل"
  },
  {
    optionA: "أن تكمل دراستك العليا في الخارج وحدك",
    optionB: "أن تعمل مباشرة وتبني خبرة عملية في السعودية"
  },
  {
    optionA: "أن تكون صادقاً دائماً حتى لو جرحت الآخرين",
    optionB: "أن تكذب أحياناً لحماية مشاعر الناس"
  },
  {
    optionA: "أن تملك وقتاً غير محدود ولكن بدون مال",
    optionB: "أن تملك مالاً غير محدود ولكن بدون وقت"
  },
  {
    optionA: "أن تعرف تاريخ نجاحك الكبير",
    optionB: "أن تعرف تاريخ أكبر فشل ستواجهه"
  },
  {
    optionA: "أن تعيش حياة مليئة بالمغامرات والمخاطر",
    optionB: "أن تعيش حياة آمنة ومستقرة ولكن روتينية"
  },
  {
    optionA: "أن تعيش تجربة حب عظيمة تنتهي بألم كبير",
    optionB: "أن لا تحب أبداً ولكن تعيش بدون ألم"
  },
  {
    optionA: "أن تكتشف أن حياتك كلها كانت كذبة",
    optionB: "أن تعيش في وهم سعيد لبقية حياتك"
  },
  {
    optionA: "أن تضحي بأحلامك من أجل شخص تحبه",
    optionB: "أن تضحي بشخص تحبه من أجل أحلامك"
  },
  {
    optionA: "أن تعرف كل أسرار الناس من حولك",
    optionB: "أن لا تعرف أي شيء عن حقيقة الناس"
  },
  {
    optionA: "أن تعيش تجربة خيانة من أقرب صديق",
    optionB: "أن لا يكون لك أصدقاء مقربين أبداً"
  },
  {
    optionA: "أن تكون محبوباً من الجميع ولكن وحيداً من الداخل",
    optionB: "أن تكون مكروهاً ولكن راضياً عن نفسك"
  },
  {
    optionA: "أن تعيش في عالم بدون موسيقى",
    optionB: "أن تعيش في عالم بدون ألوان"
  },
  {
    optionA: "أن تنسى كل ذكرياتك السعيدة",
    optionB: "أن تتذكر كل ذكرياتك المؤلمة بوضوح شديد"
  },
  {
    optionA: "أن تموت بطلاً شاباً",
    optionB: "أن تعيش طويلاً ولكن منسياً"
  },
  {
    optionA: "أن تكون قادراً على رؤية المستقبل ولكن لا تستطيع تغييره",
    optionB: "أن تكون قادراً على تغيير الماضي ولكن بعواقب غير متوقعة"
  },
  {
    optionA: "أن تعيش في عالم بدون كذب ولكن الحقيقة مؤلمة دائماً",
    optionB: "أن تعيش في عالم مليء بالأكاذيب ولكن الجميع سعداء"
  },
  {
    optionA: "أن تفقد ذاكرتك كل يوم وتبدأ من جديد",
    optionB: "أن تتذكر كل شيء بتفاصيل مؤلمة ولا تنسى أبداً"
  },
  {
    optionA: "أن تعيش حياة عادية في الواقع",
    optionB: "أن تعيش حياة مثالية في حلم لا ينتهي"
  },
  {
    optionA: "أن تكون آخر شخص على الأرض",
    optionB: "أن تعيش في عالم مزدحم ولكن لا أحد يراك"
  },
  {
    optionA: "أن تعرف تاريخ موتك بالضبط",
    optionB: "أن تعرف سبب موتك ولكن ليس التاريخ"
  },
  
  // NEW 30 engaging questions
  {
    optionA: "أن تعيش حياة مليئة بالندم على ما فعلت",
    optionB: "أن تعيش حياة مليئة بالندم على ما لم تفعل"
  },
  {
    optionA: "أن تكون قادراً على محو ذكرى واحدة من ماضيك",
    optionB: "أن تكون قادراً على استعادة ذكرى واحدة فقدتها"
  },
  {
    optionA: "أن تعرف كل لغات العالم ولكن تنسى لغتك الأم",
    optionB: "أن تتقن لغتك الأم فقط ولا تفهم أي لغة أخرى"
  },
  {
    optionA: "أن تعيش في عصر الماضي بدون تكنولوجيا",
    optionB: "أن تعيش في المستقبل البعيد بدون عائلة أو أصدقاء"
  },
  {
    optionA: "أن تكون ذكياً جداً ولكن وحيداً",
    optionB: "أن تكون متوسط الذكاء ولكن محاطاً بأحباء"
  },
  {
    optionA: "أن تخسر كل أموالك ولكن تحتفظ بذكرياتك",
    optionB: "أن تحتفظ بكل أموالك ولكن تفقد كل ذكرياتك"
  },
  {
    optionA: "أن تعيش حياة قصيرة مليئة بالإنجازات",
    optionB: "أن تعيش حياة طويلة بدون إنجازات تذكر"
  },
  {
    optionA: "أن تكون قادراً على رؤية 10 دقائق في المستقبل",
    optionB: "أن تكون قادراً على العودة 10 دقائق في الماضي"
  },
  {
    optionA: "أن تفقد حاسة البصر",
    optionB: "أن تفقد حاسة السمع"
  },
  {
    optionA: "أن تعيش في عالم بدون فن أو موسيقى",
    optionB: "أن تعيش في عالم بدون طعام لذيذ (طعام صحي فقط)"
  },
  {
    optionA: "أن تكون مشهوراً بعد موتك بـ100 سنة",
    optionB: "أن تكون مشهوراً الآن ولكن منسياً بعد موتك"
  },
  {
    optionA: "أن تعرف متى سيموت كل شخص تحبه",
    optionB: "أن لا تعرف أبداً متى سيموت أي شخص"
  },
  {
    optionA: "أن تعيش حياة مثالية ولكنها مكررة كل يوم",
    optionB: "أن تعيش حياة فوضوية ولكن مليئة بالمفاجآت"
  },
  {
    optionA: "أن تكون قادراً على الطيران ولكن بسرعة المشي فقط",
    optionB: "أن تكون قادراً على الجري بسرعة خارقة ولكن لا تطير"
  },
  {
    optionA: "أن تعيش في عالم بدون كتب",
    optionB: "أن تعيش في عالم بدون أفلام أو مسلسلات"
  },
  {
    optionA: "أن تكون قادراً على التحكم في النار",
    optionB: "أن تكون قادراً على التحكم في الماء"
  },
  {
    optionA: "أن تعيش حياة بدون نوم (لا تحتاج للنوم أبداً)",
    optionB: "أن تنام 12 ساعة يومياً ولكن بأحلام مذهلة"
  },
  {
    optionA: "أن تكون قادراً على شفاء الآخرين ولكن لا تستطيع شفاء نفسك",
    optionB: "أن تكون قادراً على شفاء نفسك فقط ولا تستطيع مساعدة الآخرين"
  },
  {
    optionA: "أن تعرف إجابة أي سؤال علمي",
    optionB: "أن تعرف إجابة أي سؤال فلسفي"
  },
  {
    optionA: "أن تعيش في عالم بدون حيوانات أليفة",
    optionB: "أن تعيش في عالم بدون نباتات أو أشجار"
  },
  {
    optionA: "أن تكون قادراً على تجميد الوقت لساعة واحدة يومياً",
    optionB: "أن تكون قادراً على تسريع الوقت لساعة واحدة يومياً"
  },
  {
    optionA: "أن تعيش حياة بدون ألم جسدي ولكن بألم نفسي مستمر",
    optionB: "أن تعيش حياة بدون ألم نفسي ولكن بألم جسدي مستمر"
  },
  {
    optionA: "أن تكون قادراً على فهم الحيوانات ولكن لا تستطيع التحدث معهم",
    optionB: "أن تكون قادراً على التحدث مع الحيوانات ولكن لا تفهمهم"
  },
  {
    optionA: "أن تعيش في عالم بدون مرايا (لا ترى نفسك أبداً)",
    optionB: "أن تعيش في عالم حيث الجميع يرى أفكارك"
  },
  {
    optionA: "أن تكون قادراً على تغيير شيء واحد في ماضيك",
    optionB: "أن تكون قادراً على معرفة شيء واحد عن مستقبلك"
  },
  {
    optionA: "أن تعيش حياة بدون عواطف (لا تشعر بأي شيء)",
    optionB: "أن تعيش حياة بعواطف مضاعفة (تشعر بكل شيء بقوة)"
  },
  {
    optionA: "أن تكون قادراً على العيش تحت الماء",
    optionB: "أن تكون قادراً على العيش في الفضاء"
  },
  {
    optionA: "أن تعرف كل أسرار الكون ولكن لا تستطيع مشاركتها",
    optionB: "أن تعيش في جهل سعيد بكل شيء"
  },
  {
    optionA: "أن تكون قادراً على تغيير مظهرك متى تشاء",
    optionB: "أن تكون قادراً على تغيير صوتك متى تشاء"
  },
  {
    optionA: "أن تعيش في عالم بدون موت (الجميع يعيش للأبد)",
    optionB: "أن تعيش في عالم حيث الحياة قصيرة جداً (50 سنة فقط)"
  },
  
  // NEW 30 deeper dilemmas
  {
    optionA: "أن تقبل وظيفة مرموقة لكن قيمها لا توافق مبادئك",
    optionB: "أن تعمل وظيفة عادية متسقة مع ضميرك"
  },
  {
    optionA: "أن تعيش في حي قريب من العائلة مع تدخلاتهم أحياناً",
    optionB: "أن تعيش بعيداً باستقلالية لكن دون شبكة دعم"
  },
  {
    optionA: "أن تُظهر حياتك علناً وتحقق تأثيراً واسعاً",
    optionB: "أن تبقى خاصاً وتؤثر في دائرة صغيرة"
  },
  {
    optionA: "أن تبدأ مشروعاً مع صديق مقرّب",
    optionB: "أن تبدأ مشروعاً وحيداً بدون شريك"
  },
  {
    optionA: "أن تتزوج بسرعة بعد تعارف قصير",
    optionB: "أن تطيل فترة الخطوبة للتأكد"
  },
  {
    optionA: "أن تعتمد على 'واسطة' لتحقيق هدف",
    optionB: "أن تنتظر طريقاً عادلاً ولو تأخر"
  },
  {
    optionA: "أن تسكن بيتاً صغيراً تملكه",
    optionB: "أن تستأجر بيتاً كبيراً في منطقة أفضل"
  },
  {
    optionA: "أن تتحمل ديناً لامتلاك منزل",
    optionB: "أن تبقى دون دين وتستثمر أموالك"
  },
  {
    optionA: "أن تهتم بصحتك على حساب وقتك الاجتماعي",
    optionB: "أن تعيش حياة اجتماعية نشطة على حساب الروتين الصحي"
  },
  {
    optionA: "أن تعتذر أولاً حتى لو كنت ترى نفسك على حق",
    optionB: "أن تنتظر اعتذار الطرف الآخر مهما طال"
  },
  {
    optionA: "أن تعمل عن بُعد من مدينة أحلامك براتب أقل",
    optionB: "أن تعمل في مدينتك براتب أعلى لكن مرونة أقل"
  },
  {
    optionA: "أن تتنازل عن هواية تحبها لأجل شريكك",
    optionB: "أن تحافظ على هوايتك حتى لو سببت خلافات"
  },
  {
    optionA: "أن تُربّي طفلاً بالتبنّي الآن",
    optionB: "أن تنتظر سنوات لأجل طفل بيولوجي"
  },
  {
    optionA: "أن تُقيم حفل زواج كبير يرضي الجميع",
    optionB: "أن تُقيم حفلاً صغيراً مخصصاً لكما فقط"
  },
  {
    optionA: "أن تُسافر لتطوير ذاتك وحدك",
    optionB: "أن تستثمر نفس المبلغ في بناء شبكة علاقات محلية"
  },
  {
    optionA: "أن تتخصص مهنياً في مجال واحد بعمق",
    optionB: "أن تكون متعدّد المهارات على حساب العمق"
  },
  {
    optionA: "أن تكون قائداً تُنتقد كثيراً",
    optionB: "أن تكون عضواً هادئاً بلا ضغوط"
  },
  {
    optionA: "أن تُنشئ محتوى عام وتتحمل التعليقات",
    optionB: "أن تبقى بعيداً عن الأضواء وتعمل بصمت"
  },
  {
    optionA: "أن تساعد قريباً بمبلغ كبير يضغط على ميزانيتك",
    optionB: "أن تعتذر وتلتزم بميزانيتك"
  },
  {
    optionA: "أن تعيش بلا سيارة في مدينة تحتاج قيادة",
    optionB: "أن تتحمل أقساط سيارة ترهق دخلك"
  },
  {
    optionA: "أن تحفظ أسرارك حتى عن شريكك",
    optionB: "أن تشارك كل شيء حتى التفاصيل المحرجة"
  },
  {
    optionA: "أن تختار تخصصاً دراسياً يحبه والداك",
    optionB: "أن تختار تخصصاً يناسبك رغم معارضة أهلك"
  },
  {
    optionA: "أن تعمل في شركة ناشئة سريعة التغيّر",
    optionB: "أن تعمل في مؤسسة مستقرة بإيقاع بطيء"
  },
  {
    optionA: "أن تُسكن والديك معك لتخدمهما",
    optionB: "أن توفّر لهما رعاية خارجية محترفة"
  },
  {
    optionA: "أن تتنازل عن صداقات قديمة من أجل زواج ناجح",
    optionB: "أن تحافظ على صداقاتك حتى لو أثّر ذلك على الزواج"
  },
  {
    optionA: "أن تلتزم بروتين صارم للإنتاجية",
    optionB: "أن تعيش بمرونة وتقبل فترات الضعف"
  },
  {
    optionA: "أن تترك عملك لعام للدراسة",
    optionB: "أن تبقى وتتعلم بجانب العمل ببطء"
  },
  {
    optionA: "أن تختار بيتاً قريباً من عملك",
    optionB: "أن تختار بيتاً قريباً من العائلة"
  },
  {
    optionA: "أن تواجه شخصاً أساء لك علناً",
    optionB: "أن تتجاهله وتمضي قدماً"
  },
  {
    optionA: "أن تضع حدوداً صارمة مع العائلة",
    optionB: "أن تُرضي العائلة ولو على حساب راحتك"
  }
];

// ماذا تفعل لو؟ – أسئلة شخصية عميقة
const whatWouldYouDoScenarios: string[] = [
  "ماذا تفعل لو اكتشفت أن صديقك المقرّب يخفي عنك سرًا كبيرًا؟ كيف تتعامل مع الموقف؟",
  "ماذا تفعل لو وجدت مبلغًا كبيرًا من المال في مكان عام؟ كيف تتصرف ولماذا؟",
  "ماذا تفعل لو طلب منك شخص غريب مساعدة عاجلة في وقت متأخر من الليل؟",
  "ماذا تفعل لو علمت أن شخصًا يحبك لكنك لا تبادله نفس المشاعر؟ كيف تتعامل مع الموقف؟",
  "ماذا تفعل لو اكتشفت أن صديقك يخون شريكه؟ هل تخبر الشريك أم لا؟ ولماذا؟",
  "ماذا تفعل لو وجدت هاتفًا ضائعًا به معلومات شخصية؟ كيف تتصرف؟",
  "ماذا تفعل لو طُلب منك الاختيار بين السفر للخارج للدراسة أو البقاء مع عائلتك؟",
  "ماذا تفعل لو اكتشفت أن شخصًا ما يكذب عليك باستمرار؟ كيف تواجهه؟",
  "ماذا تفعل لو طلبت منك والدتك شيئًا لا تريده حقًا؟ كيف تتصرف؟",
  "ماذا تفعل لو وجدت نفسك في علاقة سامة؟ كيف تخرج منها؟",
  "ماذا تفعل لو تعرضت للظلم أمام الآخرين؟ كيف تدافع عن نفسك؟",
  "ماذا تفعل لو وقعت في حب شخص من ثقافة مختلفة؟ كيف تتعامل مع التحديات؟",
  "ماذا تفعل لو اكتشفت أن صديقك يتعاطى المخدرات؟ كيف تساعده؟",
  "ماذا تفعل لو خُيرت بين مساعدة صديق أو شخص غريب في أزمة؟",
  "ماذا تفعل لو اكتشفت أن شريكك يقرأ رسائلك الخاصة؟ كيف ترد؟",
  "ماذا تفعل لو طُلب منك الكذب لإنقاذ موقف محرج؟ هل تكذب أم تصارح بالحقيقة؟",
  "ماذا تفعل لو اكتشفت أنك تعاني من مشكلة نفسية؟ كيف تتعامل مع الأمر؟",
  "ماذا تفعل لو تعرضت للتنمر؟ كيف تدافع عن نفسك؟",
  "ماذا تفعل لو اكتشفت أنك لست الابن البيولوجي لوالديك؟ كيف تتعامل مع هذه المعلومة؟",
  "ماذا تفعل لو وقعت في حب شخصين في نفس الوقت؟ كيف تختار؟",
  "ماذا تفعل لو طُلب منك التضحية بحلمك من أجل شخص تحبه؟",
  "ماذا تفعل لو اكتشفت أن صديقك يسرق من المتاجر؟ كيف تتصرف؟",
  "ماذا تفعل لو وقعت في حب شخص لا يتقبله أهلك؟",
  "ماذا تفعل لو اكتشفت أن شريكك السابق يتجسس عليك؟",
  "ماذا تفعل لو اكتشفت أن زميلاً ينسب أفكارك لنفسه أمام الإدارة؟",
  "ماذا تفعل لو تلقيت عرض عمل مغرياً من منافس لشركتك الحالية؟",
  "ماذا تفعل لو علمت أن جمعية تبرعت لها تُسيء استخدام الأموال؟",
  "ماذا تفعل لو أخطأ متجر وأعاد لك مبلغاً أكبر دون أن يلاحظ؟",
  "ماذا تفعل لو طلب منك قريب أن تضمنه في قرض وأنت غير مرتاح؟",
  "ماذا تفعل لو نشر صديقك صورتك الخاصة دون إذن؟",
  "ماذا تفعل لو فشلت في عرض مهم أمام جمهور كبير؟ كيف تتعامل بعده؟",
  "ماذا تفعل لو طلب منك مديرك تجاوز سياسة واضحة 'لمصلحة العمل'؟",
  "ماذا تفعل لو اكتشفت أن شريكك يخطط للانتقال إلى مدينة أخرى؟",
  "ماذا تفعل لو عاد شخص آذاك في الماضي طالباً الصفح بصدق؟",
  "ماذا تفعل لو شهدت حادث سير وأنت متأخر عن اختبار مصيري؟",
  "ماذا تفعل لو علمت أن صديقاً يعاني من اكتئاب لكنه يرفض المساعدة؟",
  "ماذا تفعل لو تلقيت رشوة بشكل غير مباشر مقابل خدمة بسيطة؟",
  "ماذا تفعل لو ضغط عليك أحدهم لاستخدام 'واسطة' في معاملة؟",
  "ماذا تفعل لو علمت أن صديقين مقرّبين يتشاجران بسببك؟",
  "ماذا تفعل لو اشتريت منتجاً مقلداً عن غير قصد؟ هل تُبلغ أم تتجاهل؟",
  "ماذا تفعل لو اكتشفت تسريباً لمحادثاتك الخاصة في مجموعة العمل؟",
  "ماذا تفعل لو طلبت عائلتك قطع علاقتك بشخص تحترمه؟",
  "ماذا تفعل لو تبيّن أن مشروعك المفضل سرق فكرتك؟",
  "ماذا تفعل لو أخطأت بحق موظف جديد أمام الجميع؟",
  "ماذا تفعل لو أعلن الطبيب تشخيصاً مقلقاً لكنه غير مؤكد بعد؟",
  "ماذا تفعل لو رغبت في تغيير تخصصك الدراسي بعد سنة من الدراسة؟",
  "ماذا تفعل لو واجهت تعليقات جارحة على الإنترنت بسبب رأيك؟",
  "ماذا تفعل لو طلب منك صديق أن تكذب لتغطي عليه عند أهله؟",
  "ماذا تفعل لو وجدت محفظة فيها مستندات حساسة لكن بدون رقم للتواصل؟",
  "ماذا تفعل لو اكتشفت خطأً كبيراً في عملك بعد الإرسال مباشرة؟",
  "ماذا تفعل لو طلب منك أحد أفراد العائلة مشاركة كلمة مرور حسابك؟",
  "ماذا تفعل لو تم اختيارك لقيادة فريق مختلف الآراء بشكل حاد؟",
  "ماذا تفعل لو واجهت سلوكاً مسيئاً تجاه موظف خدمة في مكان عام؟",
  "ماذا تفعل لو تعارض أقرب أصدقائك مع قرار زواجك؟ كيف تتعامل؟"
];

// ولا كلمة topics - focused on 3 main categories with no duplicates
const charadesTopics = {
  "أفلام ومسلسلات": [
    "تايتانيك", "سبايدرمان", "باتمان", "فروزن", "شريك", "هاري بوتر", "أفاتار", 
    "الأسود يليق بك", "ولد الغلابة", "الكبير أوي", "مدرسة الحب", "فيلم هندي",
    "أفنجرز", "فاست آند فيوريوس", "جوراسيك بارك", "ستار وورز", "مهمة مستحيلة", "ماتريكس",
    "مسرحية مدرسة المشاغبين", "مسرحية العيال كبرت", "مسرحية تياترو مصر", "مسرحية الواد سيد الشغال", "مسرحية الزعيم",
    "مسرحية شاهد ماشفش حاجة", "مسرحية الملك لير", "مسرحية بودي جارد", "مسرحية ريا وسكينة", "مسرحية المتزوجون",
    "مسرحية الهمجي", "مسرحية انت حر", "مسرحية الكيت كات", "مسرحية ولا في الأحلام", "مسرحية مسافر ليل",
    "مسرحية الضحك في آخر الليل", "مسرحية الفرافير", "مسرحية أهلا يا دكتور", "مسرحية جعلتني مجرما", "مسرحية الراجل اللي جوز مراته"
  ],
  "مشاهير وشخصيات": [
    "كريستيانو رونالدو", "ميسي", "محمد صلاح", "نيمار", "كيليان مبابي",
    "إيلون ماسك", "بيل جيتس", "الملكة إليزابيث", "مايكل جاكسون",
    "جيم كاري", "ويل سميث", "توم كروز", "براد بيت", "ليوناردو دي كابريو", "جاكي شان",
    "مصطفى شعبان", "عادل إمام", "محمد هنيدي", "أحمد حلمي", "رامز جلال", "أحمد مكي", "محمد رمضان",
    "تامر حسني", "عمرو دياب", "فيروز", "أم كلثوم", "محمد عبده", "راشد الماجد", "نوال الكويتية", "أصالة",
    "كاظم الساهر", "نانسي عجرم", "إليسا", "حسين الجسمي", "ماجد المهندس", "أنغام"
  ],
  "تطبيقات ومواقع": [
    "واتساب", "سناب شات", "انستقرام", "تيك توك", "يوتيوب", "تويتر", "فيسبوك",
    "جوجل", "أمازون", "نتفليكس", "سبوتيفاي", "أوبر", "كريم", "طلبات", "هنقرستيشن",
    "زوم", "تيمز", "ديسكورد", "تيليجرام", "لينكد إن", "تندر", "بلايستيشن",
    "شاهد", "ستارزبلاي", "OSN", "MBC", "روتانا", "العربية", "الجزيرة"
  ]
};

// Flatten all topics for random selection
const allCharadesWords = Object.values(charadesTopics).flat();

// Imposter categories — broad, simple, adult-friendly
const imposterCategories: Record<string, string[]> = {
    "مواقف اجتماعية": [
      "تأخير عن الموعد",
      "نسيان اسم شخص",
      "هوشة الحساب",
      "زحمة الرياض",
      "مقابلة وظيفية",
      "ضيف نشبة",
      "رسالة بالغلط",
      "بلوك مفاجئ",
      "سحبة بعد وعد",
      "طلب سلفة",
      "إحراج قدام ناس",
      "رد متأخر",
      "تدخل الأهل",
      "سوء فهم",
      "نقاش اتحول هوشة",
      "تطنيش متعمد",
      "إلغاء في آخر لحظة",
      "تجاهل في قروب",
      "كشف سر بالغلط",
      "مجاملة مو صادقة"
    ],
  
    "صفات شخصية": [
      "كاريزما",
      "ذكاء عاطفي",
      "عناد",
      "فزعة",
      "غيرة",
      "شوفة نفس",
      "غموض",
      "برود أعصاب",
      "على نياته",
      "حساس",
      "اجتماعي زيادة",
      "كتوم",
      "اندفاعي",
      "عقلاني",
      "يحب السيطرة",
      "متردد",
      "طموح",
      "ساخر",
      "مستقل",
      "سريع ملل"
    ],
  
    "أكل وشرب": [
      "كبسة",
      "مندي",
      "شاورما",
      "البيك",
      "برجر",
      "بيتزا",
      "سوشي",
      "جريش",
      "سليق",
      "إندومي",
      "مطبق",
      "فطاير",
      "مسخن",
      "مكرونة بشاميل",
      "قهوة سعودية",
      "V60",
      "سبانيش لاتيه",
      "أمريكانو",
      "شاهي كرك",
      "هوت تشوكلت",
      "آيس كوفي",
      "عصير برتقال",
      "سموذي",
      "ماء غازي"
    ],
  
    "أعمال فنية": [
      "Friends",
      "Game of Thrones",
      "Breaking Bad",
      "The Office",
      "طاش ما طاش",
      "مسامير",
      "شباب البومب",
      "رشاش",
      "باب الحارة",
      "Squid Game",
      "Titanic",
      "Interstellar",
      "The Dark Knight",
      "Joker",
      "Harry Potter",
      "Inception",
      "Forrest Gump",
      "Toy Story",
      "Home Alone",
      "Parasite"
    ],
  
    "مشاهير": [
      "محمد صلاح",
      "كريستيانو رونالدو",
      "ليونيل ميسي",
      "عادل إمام",
      "أحمد حلمي",
      "محمد عبده",
      "عمرو دياب",
      "Elon Musk",
      "تركي آل الشيخ",
      "Steve Jobs",
      "Nancy Ajram",
      "ماجد المهندس",
      "أصالة",
      "عبدالله السدحان",
      "ناصر القصبي",
      "Kanye West",
      "Andrew Tate",
      "Dwayne Johnson"
    ],
  
    "حيوانات": [
      "جمل",
      "صقر",
      "أسد",
      "ذئب",
      "قطوة",
      "كلب",
      "ضب",
      "حوت",
      "بطريق",
      "نمر",
      "فيل",
      "حصان",
      "نسر",
      "بومة",
      "ثعبان",
      "تمساح",
      "دلفين",
      "غزال"
    ]
};

// 5-Second Rule Categories - Fun & Engaging!
const fiveSecondRuleCategories = [
  // Food & Drinks 🍕
  "حلويات سعودية", "مطاعم سريعة مشهورة", "فواكه استوائية", "أطعمة إيطالية", "حلويات عربية",
  "مشروبات ساخنة", "أكلات البيت اللي تحن لها", "أشياء تطلبها دايماً من المطعم", "وجبات سريعة تحبها",
  "أطعمة تاكلها بطريقة غريبة", "مشروبات غريبة تحضّرها", "أطعمة مشهورة ما تطيقها",
  
  // Places & Travel ✈️
  "مدن سعودية", "عواصم عربية", "دول أوروبية", "جزر سياحية", "معالم في الرياض",
  "دول آسيوية", "أماكن تاريخية", "دول تتمنى تزورها", "أماكن بالسعودية ما زرتها لحد الآن",
  "مواقف مضحكة في السفر", "أشياء تنساها دايماً في الرحلات", "مدن ساحلية",
  
  // Entertainment & Media 🎬
  "أفلام تعيد مشاهدتها مليون مرة", "مسلسلات سعودية", "مسلسلات كورية", "ألعاب فيديو مشهورة",
  "برامج واقع", "أفلام كرتون من الطفولة", "مسلسلات تابعتها بنهم", "قنوات تلفزيونية",
  "أفلام ومسلسلات مبالغ في تقييمها", "نهايات مسلسلات أو أفلام كرهتها", "ممثلين أو ممثلات تحبهم",
  
  // Technology & Apps 📱
  "تطبيقات ما تقدر تعيش بدونها", "منصات تسوق إلكتروني", "شركات تقنية", "مواقع تواصل اجتماعي",
  "منصات ترفيه", "تطبيقات على الهاتف", "شركات سيارات", "ماركات ملابس فاخرة",
  "أشياء تسويها أول ما تصحى", "مواقف محرجة بسبب التصحيح التلقائي", "أشياء تنرفز منها في مواقع التواصل",
  
  // Sports & Activities ⚽
  "رياضات جماعية", "رياضات مائية", "رياضات شتوية", "رياضات شعبية في السعودية",
  "تمارين رياضية", "ألعاب أولمبية", "رياضات قتالية", "أعذار لعدم الرياضة",
  
  // Childhood & Nostalgia 🎮
  "كرتون أو ألعاب من طفولتك", "أشياء كنت تخاف منها وأنت صغير", "أكاذيب صدقتها لما كنت طفل",
  "عقوبات من أهلك ما تنساها", "مواقف محرجة حصلت لك في المدرسة", "ألعاب خطيرة لعبتها وأنت صغير",
  
  // Personality & Habits 🎭
  "أشياء تفعلها عندما تكون وحيداً", "عادات غريبة عندك", "أشياء تفكر فيها قبل النوم",
  "مخاوف غير منطقية لديك", "أشياء تجعلك تبكي", "عادات تعترف بها", "طقوس غريبة لازم تسويها",
  "خرافات أو توهمات تؤمن فيها", "عادات عصبية لما تتوتر", "أشياء تجمعها بدون سبب",
  
  // Social Life 👥
  "أعذار تستخدمها لإلغاء الخطط", "أنواع من الناس تتجنبهم", "مواقف محرجة في المناسبات",
  "أنواع محادثات تكرهها", "أشياء تقولها عشان تنهي المحادثة", "مواقف محرجة في المصعد",
  "أنواع من الضيوف المزعجين", "أشياء الكل يحبها وأنت تكرهها", "آراء غير شعبية عندك",
  
  // Money & Shopping 💰
  "أشياء تبذّر فيها فلوسك", "مشتريات ندمت عليها", "أشياء رخيصة ما تشتريها أبداً",
  "أشياء غالية بس تستاهل", "عادات مالية سيئة عندك", "ماركات ساعات", "ماركات عطور",
  
  // Daily Life & Routines 😴
  "أشياء تسويها عشان تصحى", "أعذار لتأجيل المنبه", "أشياء تسويها قبل النوم",
  "كوابيس أو أحلام غريبة تتكرر", "أشياء ما تقدر تنام بدونها", "عادات نوم غريبة عندك",
  
  // Pet Peeves 😤
  "أصوات تنرفزك", "عادات ناس تستفزك", "كلمات أو عبارات تكرهها",
  "أشياء في الآداب العامة تستفزك", "تصرفات في السياقة تجننك", "أنواع من الزحمة ما تطيقها",
  
  // Work & Education 💼
  "أعذار للتأخير عن العمل أو الدراسة", "تخصصات جامعية", "وظائف طبية", "وظائف تقنية",
  "مهن إبداعية", "جامعات سعودية", "لغات عالمية", "أشياء تنرفزك في بيئة العمل",
  
  // Hobbies & Interests 🎨
  "هوايات داخلية", "هوايات خارجية", "حرف يدوية", "فنون", "أنواع من الرسم",
  "ألعاب ورقية", "ألعاب لوحية", "هوايات إبداعية", "مجموعات يمكن جمعها",
  
  // Saudi Culture 🇸🇦
  "أطباق سعودية", "أماكن سياحية في السعودية", "مناسبات سعودية", "ملابس تقليدية",
  "مدن تراثية", "صحاري سعودية", "أسواق شعبية", "أكلات شعبية", "عبارات سعودية ما تنفهم في مناطق ثانية",
  "أشياء تصير بس في السعودية", "عادات عوائل سعودية", "مناطق وأحياء في السعودية",
  
  // Random & Fun 🎲
  "أشياء لو كنت ملك العالم بتلغيها", "قوى خارقة عديمة الفائدة تتمنى تملكها", "أشياء عادية تحسها مريحة",
  "مواهب غريبة عندك", "أشياء بسيطة تسعدك", "لو كنت حيوان، وش تكون؟", "نصايح سيئة ممكن تعطيها",
  "أشياء حمراء", "أشياء دائرية", "أشياء في الثلاجة", "أسماء بنات", "أسماء أولاد", "ألوان"
];

export default function GroupsPage() {
  const SESSION_TOTAL_DURATION = 45 * 60; // 45 minutes in seconds
  const IMPOSTER_TUTORIAL_KEY = "imposter_tutorial_seen";
  const [currentGameIndex, setCurrentGameIndex] = useState(0);
  const [gameStarted, setGameStarted] = useState(false);
  const [selectedGameId, setSelectedGameId] = useState<string | null>(null);
  const [currentPromptIndex, setCurrentPromptIndex] = useState(0);
  const [gamePhase, setGamePhase] = useState<"intro" | "playing" | "completed">("intro");
  const [showPromptTopicsModal, setShowPromptTopicsModal] = useState(false);
  // Groups page lock
  const [groupsLocked, setGroupsLocked] = useState(false);
  const [isConfirmed, setIsConfirmed] = useState(false);
  // Semi-login by phone state
  const [phoneNumber, setPhoneNumber] = useState<string>("");
  const [phoneLoading, setPhoneLoading] = useState(false);
  const [phoneError, setPhoneError] = useState<string | null>(null);
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [savedAuthToken, setSavedAuthToken] = useState<string | null>(null);
  const [eventPhase, setEventPhase] = useState<string | null>(null);
  const [eventCurrentRound, setEventCurrentRound] = useState<number | null>(null);
  const [joiningTransition, setJoiningTransition] = useState(false);
  const preGameRef = useRef<HTMLDivElement | null>(null);
  
  // Shuffled questions state
  const [shuffledNeverHaveIEver, setShuffledNeverHaveIEver] = useState<string[]>([]);
  const [shuffledWouldYouRather, setShuffledWouldYouRather] = useState<typeof wouldYouRatherQuestions>([]);
  const [shuffledWhatWouldYouDo, setShuffledWhatWouldYouDo] = useState<string[]>([]);
  
  // Charades game state
  const [currentCharadesWord, setCurrentCharadesWord] = useState<string>("");
  const [currentCharadesCategory, setCurrentCharadesCategory] = useState<string>("");
  const [charadesTimer, setCharadesTimer] = useState(90); // 90 seconds (1:30) per word
  const [charadesTimerActive, setCharadesTimerActive] = useState(false);
  const [charadesScore, setCharadesScore] = useState({ correct: 0, total: 0 });
  
  // Imposter game state
  const [imposterPhase, setImposterPhase] = useState<"setup" | "reveal" | "discussion" | "voting" | "result">("setup");
  const [imposterPlayers, setImposterPlayers] = useState<string[]>(["", "", "", ""]);
  const [imposterSelectedCategory, setImposterSelectedCategory] = useState<string>(Object.keys(imposterCategories)[0]);
  const [imposterSecretWord, setImposterSecretWord] = useState<string>("");
  const [imposterIndex, setImposterIndex] = useState<number>(-1);
  const [revealIndex, setRevealIndex] = useState<number>(0);
  const [revealShown, setRevealShown] = useState<boolean>(false);
  const [voteTurn, setVoteTurn] = useState<number>(0);
  const [votes, setVotes] = useState<Record<number, number>>({}); // voter -> target
  const [accusedIndex, setAccusedIndex] = useState<number | null>(null);
  // Q&A pairs before voting
  const [qaPairs, setQAPairs] = useState<Array<{ asker: number; target: number }>>([]);
  const [qaIndex, setQAIndex] = useState<number>(0);
  // Imposter UX helpers
  const [imposterError, setImposterError] = useState<string | null>(null);
  const [imposterShowTutorial, setImposterShowTutorial] = useState(false);
  const [imposterTutorialSlide, setImposterTutorialSlide] = useState(0);
  
  // 5-Second Rule game state
  const [currentCategory, setCurrentCategory] = useState<string>("");
  const [fiveSecondTimer, setFiveSecondTimer] = useState(5);
  const [fiveSecondTimerActive, setFiveSecondTimerActive] = useState(false);
  const [fiveSecondScore, setFiveSecondScore] = useState({ success: 0, total: 0 });
  const [shuffledCategories, setShuffledCategories] = useState<string[]>([]);
  const [categoryIndex, setCategoryIndex] = useState(0);
  const [roundCompleted, setRoundCompleted] = useState(false);
  const [isReadingPhase, setIsReadingPhase] = useState(false);
  const [readingTimer, setReadingTimer] = useState(3); // 3 seconds reading time
  
  // Participant data state
  const [participantName, setParticipantName] = useState<string>("");
  const [participantNumber, setParticipantNumber] = useState<number | null>(null);
  const [tableNumber, setTableNumber] = useState<number | null>(null);
  const [groupMembers, setGroupMembers] = useState<string[]>([]);
  const [dataLoaded, setDataLoaded] = useState(false);
  // How-to tutorial modal
  const [showHowToModal, setShowHowToModal] = useState(false);
  const [howToSlide, setHowToSlide] = useState(0);

  // Derive participant numbers for the onboarding modal (avoid names)
  const participantNumbersList = useMemo(() => {
    const nums: number[] = [];
    try {
      for (const gm of groupMembers || []) {
        if (typeof gm === 'string') {
          const m = gm.match(/#(\d{1,4})/);
          if (m && m[1]) {
            const n = parseInt(m[1], 10);
            if (Number.isFinite(n)) nums.push(n);
          }
        }
      }
    } catch {}
    if (participantNumber && !nums.includes(participantNumber)) nums.unshift(participantNumber);
    return nums;
  }, [groupMembers, participantNumber]);
  
  // Timer state
  const [timeRemaining, setTimeRemaining] = useState(SESSION_TOTAL_DURATION);
  const [timerActive, setTimerActive] = useState(false);
  const [showTimeUpModal, setShowTimeUpModal] = useState(false);
  const [showIndividualRoundsModal, setShowIndividualRoundsModal] = useState(false);
  
  // Group guide popup state
  const [showGroupGuide, setShowGroupGuide] = useState(false);

  const currentGame = games[currentGameIndex];

  // Shuffle array function
  const shuffleArray = <T,>(array: T[]): T[] => {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  };

  // Imposter helpers
  const resetImposter = () => {
    setImposterPhase("setup");
    setImposterPlayers(p => p.length < 4 ? ["", "", "", ""] : p.slice(0, 4));
    setImposterSelectedCategory(Object.keys(imposterCategories)[0]);
    setImposterSecretWord("");
    setImposterIndex(-1);
    setRevealIndex(0);
    setRevealShown(false);
    setVoteTurn(0);
    setVotes({});
    setAccusedIndex(null);
    setQAPairs([]);
    setQAIndex(0);
  };

  // Build directed round-robin Q&A pairs so that each player asks every other player exactly once.
  // The schedule is randomized in appearance by shuffling the base order, the round offsets, and the per-round asker order.
  // Additionally, we bias the very first question to avoid targeting the imposter 95% of the time (5% chance allowed).
  const generateImposterQAPairs = (playerCount: number, impIdx: number): Array<{ asker: number; target: number }> => {
    if (playerCount <= 1) return [];

    const base = Array.from({ length: playerCount }, (_, i) => i);
    const order = shuffleArray(base); // random base permutation
    const offsets = shuffleArray(Array.from({ length: playerCount - 1 }, (_, k) => k + 1)); // 1..N-1 in random order

    const pairs: Array<{ asker: number; target: number }> = [];

    // For each offset (round), every player i asks player (i+offset) mod N
    for (const offset of offsets) {
      // Randomize the order of askers within this round for a more organic feel
      const askersIdx = shuffleArray(base);
      for (const i of askersIdx) {
        const asker = order[i];
        const target = order[(i + offset) % playerCount];
        if (asker !== target) {
          pairs.push({ asker, target });
        }
      }
    }

    // Bias the first question away from targeting the imposter (only 5% chance to target imposter first)
    if (pairs.length > 0) {
      const firstTargetsImposter = pairs[0].target === impIdx;
      if (firstTargetsImposter) {
        // With 95% probability, swap with a non-imposter-target pair
        if (Math.random() >= 0.05) {
          const swapIndex = pairs.findIndex(p => p.target !== impIdx);
          if (swapIndex > 0) {
            const tmp = pairs[0];
            pairs[0] = pairs[swapIndex];
            pairs[swapIndex] = tmp;
          }
        }
      } else {
        // With 5% probability, move an imposter-targeting pair to the front (to allow occasional first-hit)
        if (Math.random() < 0.05) {
          const swapIndex = pairs.findIndex(p => p.target === impIdx);
          if (swapIndex > 0) {
            const tmp = pairs[0];
            pairs[0] = pairs[swapIndex];
            pairs[swapIndex] = tmp;
          }
        }
      }
    }

    return pairs;
  };

  const startImposterRound = () => {
    const names = imposterPlayers.map(n => n.trim()).filter(Boolean);
    if (names.length < 4 || names.length > 6) {
      setImposterError("يرجى إدخال 4 إلى 6 أسماء لاعبين");
      return;
    }
    setImposterError(null);
    // Random secret word
    const words = imposterCategories[imposterSelectedCategory] || [];
    const secret = words[Math.floor(Math.random() * words.length)] || "كلمة";
    setImposterSecretWord(secret);
    // Random imposter index
    const impIdx = Math.floor(Math.random() * names.length);
    setImposterIndex(impIdx);
    // Normalize players to trimmed list
    setImposterPlayers(names);
    setRevealIndex(0);
    setRevealShown(false);
    setVotes({});
    setVoteTurn(0);
    setAccusedIndex(null);
    setQAPairs([]);
    setQAIndex(0);
    setImposterPhase("reveal");
  };

  const nextReveal = () => {
    if (!revealShown) { setRevealShown(true); return; }
    // Hide and move to next
    setRevealShown(false);
    if (revealIndex >= imposterPlayers.length - 1) {
      // Build a full directed round-robin schedule (each player asks every other player once)
      const n = imposterPlayers.length;
      const pairs = generateImposterQAPairs(n, imposterIndex);
      setQAPairs(pairs);
      setQAIndex(0);
      setImposterPhase("discussion");
    } else {
      setRevealIndex(revealIndex + 1);
    }
  };

  const startVoting = () => {
    setVoteTurn(0);
    setVotes({});
    setImposterPhase("voting");
  };

  const castVote = (targetIdx: number) => {
    setVotes(prev => ({ ...prev, [voteTurn]: targetIdx }));
    if (voteTurn >= imposterPlayers.length - 1) {
      // Tally
      const counts: Record<number, number> = {};
      Object.values({ ...votes, [voteTurn]: targetIdx }).forEach(t => {
        counts[t] = (counts[t] || 0) + 1;
      });
      let max = -1; let accused = 0;
      Object.keys(counts).forEach(k => {
        const idx = parseInt(k);
        if (counts[idx] > max) { max = counts[idx]; accused = idx; }
      });
      setAccusedIndex(accused);
      setImposterPhase("result");
    } else {
      setVoteTurn(voteTurn + 1);
    }
  };

  const newImposterRound = () => {
    // Keep players and category, randomize new roles and word
    const names = imposterPlayers;
    if (!names || names.length < 4) { resetImposter(); return; }
    const words = imposterCategories[imposterSelectedCategory] || [];
    const secret = words[Math.floor(Math.random() * words.length)] || "كلمة";
    setImposterSecretWord(secret);
    const impIdx = Math.floor(Math.random() * names.length);
    setImposterIndex(impIdx);
    setRevealIndex(0);
    setRevealShown(false);
    setVotes({});
    setVoteTurn(0);
    setAccusedIndex(null);
    setQAPairs([]);
    setQAIndex(0);
    setImposterPhase("reveal");
  };

  // Handle browser back button intelligently based on current state
  useEffect(() => {
    const handlePopState = (event: PopStateEvent) => {
      event.preventDefault();
      
      // If currently in a game session, go back to main groups page
      if (gameStarted) {
        setGameStarted(false);
        setCurrentGameIndex(0);
        setGamePhase("intro");
        setTimeRemaining(30 * 60); // Reset timer
        setTimerActive(false);
        setShowTimeUpModal(false);
        setShowIndividualRoundsModal(false);
        setCharadesTimerActive(false);
        setCharadesTimer(90);
      } else {
        // If on main groups page, go to welcome page
        window.location.href = "/welcome";
      }
    };

    // Add event listener for browser back button
    window.addEventListener('popstate', handlePopState);

    // Push current state to history so back button is intercepted
    window.history.pushState(null, '', window.location.pathname);

    // Cleanup event listener on component unmount
    return () => {
      window.removeEventListener('popstate', handlePopState);
    };
  }, [gameStarted]); // Add gameStarted as dependency

  // Debug: Log tableNumber changes
  useEffect(() => {
    console.log('🔍 tableNumber state changed:', tableNumber);
  }, [tableNumber]);

  // Show group guide only AFTER onboarding is finished
  useEffect(() => {
    if (!isConfirmed) return;
    // Wait until onboarding has been completed (localStorage flag set by OnboardingModal)
    let onboardingSeen = false;
    try {
      onboardingSeen = localStorage.getItem('groups_onboarding_seen') === 'true';
    } catch {}
    if (!onboardingSeen) return;
    const hasSeenGroupGuide = localStorage.getItem('blindmatch_group_guide_seen');
    if (!hasSeenGroupGuide) {
      setShowGroupGuide(true);
    }
  }, [isConfirmed, showOnboarding]);

  // Load participant data and group assignment on component mount
  useEffect(() => {
    const loadParticipantData = async () => {
      try {
        // Fetch event state to check if groups page is locked
        try {
          const stateRes = await fetch("/api/admin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "get-event-state" }),
          });
          if (stateRes.ok) {
            const stateData = await stateRes.json();
            setGroupsLocked(stateData.groups_locked === true);
          }
        } catch (e) {
          console.warn("Could not fetch event state for groups lock:", e);
        }
        // Get saved token from localStorage
        const savedToken = localStorage.getItem('blindmatch_result_token') || 
                          localStorage.getItem('blindmatch_returning_token');
        setSavedAuthToken(savedToken);

        if (!savedToken) {
          // Try restoring semi-login session for groups
          try {
            const cached = sessionStorage.getItem('groups_semi_login');
            if (cached) {
              const parsed = JSON.parse(cached);
              if (parsed && parsed.assigned_number) {
                setIsConfirmed(true);
                setParticipantNumber(parsed.assigned_number);
                setParticipantName(parsed.name || `المشارك #${parsed.assigned_number}`);
                if (Number.isFinite(parsed.table_number)) setTableNumber(parsed.table_number);
                if (Array.isArray(parsed.group_members)) setGroupMembers(parsed.group_members);
                setDataLoaded(true);
                const seen = localStorage.getItem('groups_onboarding_seen');
                if (!seen) setShowOnboarding(true);
                return;
              }
            }
          } catch (e) {
            console.warn('Failed to restore semi-login session', e);
          }
          console.log('No saved token found');
          setIsConfirmed(false);
          setDataLoaded(true);
          return;
        }

        // Resolve participant data
        const participantRes = await fetch("/api/participant", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            action: "resolve-token", 
            secure_token: savedToken 
          }),
        });

        if (!participantRes.ok) {
          console.error('Failed to resolve participant token');
          setDataLoaded(true);
          return;
        }

        const participantData = await participantRes.json();
        
        if (participantData.success && participantData.assigned_number) {
          setIsConfirmed(true);
          const name = participantData.name || participantData.survey_data?.name || `المشارك #${participantData.assigned_number}`;
          setParticipantName(name);
          setParticipantNumber(participantData.assigned_number);

          // Try to fetch group assignment (fallback gracefully if fails)
          try {
            // First, get the current active event
            const eventStateRes = await fetch("/api/admin", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-current-event-id"
              })
            });

            let currentEventId = 1; // Default fallback
            if (eventStateRes.ok) {
              const eventState = await eventStateRes.json();
              currentEventId = eventState.current_event_id || 1;
              console.log(`📅 Current active event: ${currentEventId}`);
            } else {
              console.log('⚠️ Could not fetch current event ID, using default: 1');
            }

            // Fetch group matches for the current active event
            const groupRes = await fetch("/api/admin", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "get-group-matches",
                event_id: currentEventId
              }),
            });

            if (groupRes.ok) {
              const groupData = await groupRes.json();
              
              // Find the group that contains this participant
              // Note: participant_numbers can be stored as strings or numbers, so check both
              const userGroup = groupData.groups?.find((group: any) => {
                const participantNumbers = group.participant_numbers || [];
                return participantNumbers.includes(participantData.assigned_number) || 
                       participantNumbers.includes(String(participantData.assigned_number)) ||
                       participantNumbers.map(String).includes(String(participantData.assigned_number));
              });

              if (userGroup) {
                console.log(`✅ Found group assignment:`, userGroup);
                console.log(`Setting table number to: ${userGroup.table_number}`);
                setTableNumber(userGroup.table_number);
                // Combine names with ages if provided by API
                const names: string[] = Array.isArray(userGroup.participant_names) ? userGroup.participant_names : [];
                const ages: Array<number | null | undefined> = Array.isArray(userGroup.participant_ages) ? userGroup.participant_ages : [];
                const combined = names.map((name: string, idx: number) => {
                  const age = ages[idx];
                  const ageNumber = typeof age === 'string' ? parseInt(age as any, 10) : age;
                  return Number.isFinite(ageNumber) && ageNumber ? `${name} (${ageNumber})` : name;
                });
                setGroupMembers(combined);
                console.log(`✅ Table number set - Table #${userGroup.table_number} (Event ${currentEventId})`);
              } else {
                console.log(`⚠️ No group assignment found for participant #${participantData.assigned_number} in event ${currentEventId}`);
                console.log('Participant assigned_number type:', typeof participantData.assigned_number, participantData.assigned_number);
                console.log('Available groups:', groupData.groups?.map((g: any) => ({ 
                  table: g.table_number, 
                  participants: g.participant_numbers,
                  participantTypes: g.participant_numbers?.map((p: any) => typeof p)
                })));
              }
            }
          } catch (groupError) {
            console.log('Could not fetch group assignment, continuing without table info');
            // Continue without group info - don't set error state
          }
        }
      } catch (error) {
        console.error('Error loading participant data:', error);
      } finally {
        setDataLoaded(true);
      }
    };

    loadParticipantData();
  }, []);

  // Poll event state: if admin switches to rounds, redirect or show instructions
  useEffect(() => {
    let mounted = true;
    let interval: any;
    const poll = async () => {
      try {
        const res = await fetch("/api/admin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "get-event-state" })
        });
        if (!res.ok) return;
        const data = await res.json();
        const phase = data?.phase || null;
        const round = data?.current_round || null;
        const locked = data?.groups_locked === true;
        if (mounted) {
          if (typeof locked === 'boolean') setGroupsLocked(locked);
          setEventPhase(phase);
          if (Number.isFinite(round)) setEventCurrentRound(round);
          if (phase && /^round_/i.test(phase)) {
            // If user has a token, send them to welcome with forced round
            if (savedAuthToken) {
              const q = round ? `&force_round=${round}` : "";
              window.location.href = `/welcome?token=${encodeURIComponent(savedAuthToken)}${q}`;
            } else {
              // No token (semi-login). Only show how-to AFTER onboarding is finished
              let onboardingSeen = false;
              try {
                onboardingSeen = localStorage.getItem('groups_onboarding_seen') === 'true';
              } catch {}
              if (!showOnboarding && onboardingSeen) {
                setShowHowToModal(true);
              } else {
                setShowHowToModal(false);
              }
            }
          }
        }
      } catch (_) {}
    };
    interval = setInterval(poll, 5000);
    poll();
    return () => { mounted = false; clearInterval(interval); };
  }, [savedAuthToken]);

  // Phone login handler for semi-login flow
  const handlePhoneLogin = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    setPhoneError(null);
    const raw = phoneNumber || "";
    const digits = raw.replace(/\D/g, "");
    if (digits.length < 7) {
      setPhoneError("رقم الهاتف يجب أن يحتوي على 7 أرقام على الأقل");
      return;
    }
    setPhoneLoading(true);
    try {
      const res = await fetch("/api/participant", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "group-phone-login", phone_number: raw })
      });
      const data = await res.json();
      if (!res.ok || !data?.success) {
        setPhoneError(data?.error || "فشل تسجيل الدخول. حاول مرة أخرى");
        return;
      }
      setIsConfirmed(true);
      setParticipantNumber(data.assigned_number || null);
      setParticipantName(data.name || `المشارك #${data.assigned_number}`);
      setTableNumber(Number.isFinite(data.table_number) ? data.table_number : null);
      if (Array.isArray(data.group_members)) setGroupMembers(data.group_members);
      try {
        sessionStorage.setItem('groups_semi_login', JSON.stringify({
          assigned_number: data.assigned_number,
          name: data.name,
          table_number: data.table_number ?? null,
          group_members: data.group_members || []
        }));
      } catch (_) {}
      setDataLoaded(true);
      const seen = localStorage.getItem('groups_onboarding_seen');
      if (!seen) setShowOnboarding(true);
    } catch (err) {
      setPhoneError("تعذر الاتصال بالخادم. حاول لاحقاً");
    } finally {
      setPhoneLoading(false);
    }
  };

  // Digits-based submit for the immersive PhoneEntry component
  const submitPhoneDigits = async (digits: string) => {
    setPhoneError(null);
    const d = (digits || "").replace(/\D/g, "");
    if (d.length < 7) {
      setPhoneError("رقم الهاتف يجب أن يحتوي على 7 أرقام على الأقل");
      throw new Error("invalid-phone");
    }
    setPhoneLoading(true);
    try {
      const res = await fetch("/api/participant", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "group-phone-login", phone_number: d })
      });
      const data = await res.json();
      if (!res.ok || !data?.success) {
        setPhoneError(data?.error || "فشل تسجيل الدخول. حاول مرة أخرى");
        throw new Error(data?.error || "login-failed");
      }
      setParticipantNumber(data.assigned_number || null);
      setParticipantName(data.name || `المشارك #${data.assigned_number}`);
      setTableNumber(Number.isFinite(data.table_number) ? data.table_number : null);
      if (Array.isArray(data.group_members)) setGroupMembers(data.group_members);
      try {
        if (data?.name) localStorage.setItem('blindmatch_participant_name', data.name);
      } catch (_) {}
      try {
        sessionStorage.setItem('groups_semi_login', JSON.stringify({
          assigned_number: data.assigned_number,
          name: data.name,
          table_number: data.table_number ?? null,
          group_members: data.group_members || []
        }));
      } catch (_) {}
      setDataLoaded(true);
      // Allow PhoneEntry screen-wipe to play smoothly before swapping pages
      setJoiningTransition(true);
      setTimeout(() => {
        setIsConfirmed(true);
        setJoiningTransition(false);
        try {
          const seen = localStorage.getItem('groups_onboarding_seen');
          if (!seen) setShowOnboarding(true);
        } catch {}
      }, 720);
    } catch (err) {
      // Re-throw to let the PhoneEntry component cancel success animation
      throw err;
    } finally {
      setPhoneLoading(false);
    }
  };

  // Main timer useEffect with session sync
  useEffect(() => {
    let interval: NodeJS.Timeout;
    const SESSION_KEY = 'groups_session_data';
    const TOTAL_DURATION = SESSION_TOTAL_DURATION;
    
    if (timerActive && timeRemaining > 0) {
      interval = setInterval(() => {
        // Recalculate from saved start time for accuracy
        try {
          const savedSession = localStorage.getItem(SESSION_KEY);
          if (savedSession) {
            const { startTime } = JSON.parse(savedSession);
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const calculatedRemaining = Math.max(0, TOTAL_DURATION - elapsedSeconds);
            
            setTimeRemaining(calculatedRemaining);
            
            if (calculatedRemaining <= 0) {
              setTimerActive(false);
              setShowTimeUpModal(true);
              setShowIndividualRoundsModal(true);
              localStorage.removeItem(SESSION_KEY);
            }
          } else {
            // Fallback to decrement if no session
            setTimeRemaining(prev => {
              if (prev <= 1) {
                setTimerActive(false);
                setShowTimeUpModal(true);
                setShowIndividualRoundsModal(true);
                return 0;
              }
              return prev - 1;
            });
          }
        } catch (error) {
          console.error('Timer sync error:', error);
          // Fallback to simple decrement
          setTimeRemaining(prev => {
            if (prev <= 1) {
              setTimerActive(false);
              setShowTimeUpModal(true);
              setShowIndividualRoundsModal(true);
              return 0;
            }
            return prev - 1;
          });
        }
      }, 1000);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [timerActive, timeRemaining]);

  // Charades timer useEffect
  useEffect(() => {
    let interval: NodeJS.Timeout;
    
    if (charadesTimerActive && charadesTimer > 0) {
      interval = setInterval(() => {
        setCharadesTimer(prev => {
          if (prev <= 1) {
            setCharadesTimerActive(false);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [charadesTimerActive, charadesTimer]);

  // Reading phase timer useEffect
  useEffect(() => {
    let interval: NodeJS.Timeout;
    
    if (isReadingPhase && readingTimer > 0) {
      interval = setInterval(() => {
        setReadingTimer(prev => {
          if (prev <= 1) {
            // Reading phase done, start game timer
            setIsReadingPhase(false);
            setFiveSecondTimerActive(true);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [isReadingPhase, readingTimer]);

  // 5-Second Rule timer useEffect
  useEffect(() => {
    let interval: NodeJS.Timeout;
    
    if (fiveSecondTimerActive && fiveSecondTimer > 0) {
      interval = setInterval(() => {
        setFiveSecondTimer(prev => {
          if (prev <= 1) {
            setFiveSecondTimerActive(false);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [fiveSecondTimerActive, fiveSecondTimer]);

  // Entry animation for pre-game container (mirrors PhoneEntry feel)
  useEffect(() => {
    if (preGameRef.current) {
      try {
        animate(
          preGameRef.current!,
          { opacity: [0, 1], transform: ['translateY(16px) scale(0.98)', 'translateY(0px) scale(1)'] } as any,
          { duration: 0.38, easing: 'cubic-bezier(.22,.61,.36,1)' } as any
        );
      } catch {}
    }
  }, []);

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Session persistence with daily reset
  useEffect(() => {
    const SESSION_KEY = 'groups_session_data';
    const TOTAL_DURATION = 30 * 60; // 30 minutes in seconds

    // Load session on mount
    const loadSession = () => {
      try {
        const savedSession = localStorage.getItem(SESSION_KEY);
        if (savedSession) {
          const { startTime, startDate } = JSON.parse(savedSession);
          const savedDate = new Date(startDate).toDateString();
          const currentDate = new Date().toDateString();

          // Check if it's the same day
          if (savedDate === currentDate) {
            // Calculate elapsed time
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const remaining = Math.max(0, TOTAL_DURATION - elapsedSeconds);

            if (remaining > 0) {
              // Resume session
              setTimeRemaining(remaining);
              setGameStarted(true);
              setTimerActive(true);
              console.log(`📅 Resumed session: ${remaining}s remaining`);
            } else {
              // Session expired
              localStorage.removeItem(SESSION_KEY);
              console.log('⏰ Session expired, cleared');
            }
          } else {
            // Different day, clear session
            localStorage.removeItem(SESSION_KEY);
            console.log('📅 New day, session cleared');
          }
        }
      } catch (error) {
        console.error('Failed to load session:', error);
        localStorage.removeItem(SESSION_KEY);
      }
    };

    loadSession();
  }, []);

  const startSession = () => {
    const SESSION_KEY = 'groups_session_data';
    const existingSession = localStorage.getItem(SESSION_KEY);

    if (!existingSession) {
      const startTime = Date.now();
      const startDate = new Date().toISOString();

      // Save session start time only when starting fresh
      try {
        localStorage.setItem(SESSION_KEY, JSON.stringify({ startTime, startDate }));
        console.log('💾 Session started and saved:', new Date(startTime).toLocaleTimeString());
      } catch (error) {
        console.error('Failed to save session:', error);
      }

      setTimeRemaining(SESSION_TOTAL_DURATION);
    } else {
      console.log('⏳ Resuming existing session without resetting.');
    }

    setGameStarted(true);
    setTimerActive(true);
  };


  const startGame = (gameId: string) => {
    setSelectedGameId(gameId);
    setGamePhase("playing");
    setCurrentPromptIndex(0);
    
    // Shuffle questions when starting the game
    if (gameId === "never-have-i-ever") {
      setShuffledNeverHaveIEver(shuffleArray(neverHaveIEverQuestions));
    } else if (gameId === "would-you-rather") {
      setShuffledWouldYouRather(shuffleArray(wouldYouRatherQuestions));
    } else if (gameId === "what-would-you-do") {
      setShuffledWhatWouldYouDo(shuffleArray(whatWouldYouDoScenarios));
    } else if (gameId === "5-second-rule") {
      setShuffledCategories(shuffleArray(fiveSecondRuleCategories));
      setCategoryIndex(0);
    } else if (gameId === "imposter") {
      // Show tutorial the first time only
      setImposterError(null);
      try {
        const seen = localStorage.getItem(IMPOSTER_TUTORIAL_KEY);
        if (!seen) setImposterShowTutorial(true);
      } catch {}
    }
  };

  const nextGame = () => {
    if (currentGameIndex < games.length - 1) {
      setCurrentGameIndex(prev => prev + 1);
      setGamePhase("intro");
    } else {
      // All games completed
      setGamePhase("completed");
    }
  };

  // Header collapse: collapse when a game is selected, expand on return
  const [headerCollapsed, setHeaderCollapsed] = useState(false);
  useEffect(() => {
    setHeaderCollapsed(!!selectedGameId);
  }, [selectedGameId]);

  // Charades helper functions
  const getRandomCharadesWord = () => {
    const randomWord = allCharadesWords[Math.floor(Math.random() * allCharadesWords.length)];
    
    // Find which category this word belongs to
    const category = Object.entries(charadesTopics).find(([_, words]) => 
      words.includes(randomWord)
    )?.[0] || "عام";
    
    setCurrentCharadesWord(randomWord);
    setCurrentCharadesCategory(category);
    setCharadesTimer(90); // 90 seconds (1:30)
    setCharadesTimerActive(false);
  };

  const startCharadesRound = () => {
    getRandomCharadesWord();
    setCharadesTimerActive(true);
  };

  const charadesCorrect = () => {
    setCharadesScore(prev => ({ correct: prev.correct + 1, total: prev.total + 1 }));
    setCharadesTimerActive(false);
    getRandomCharadesWord();
  };

  const charadesSkip = () => {
    setCharadesScore(prev => ({ correct: prev.correct, total: prev.total + 1 }));
    setCharadesTimerActive(false);
    getRandomCharadesWord();
  };

  // 5-Second Rule helper functions
  const startFiveSecondRound = () => {
    const category = shuffledCategories[categoryIndex] || fiveSecondRuleCategories[0];
    setCurrentCategory(category);
    setReadingTimer(3); // Reset reading timer
    setIsReadingPhase(true); // Start reading phase first
    setFiveSecondTimer(5); // Prepare game timer
    setFiveSecondTimerActive(false); // Don't start game timer yet
    setRoundCompleted(false);
  };

  const fiveSecondSuccess = () => {
    setFiveSecondScore(prev => ({ success: prev.success + 1, total: prev.total + 1 }));
    setFiveSecondTimerActive(false);
    setCategoryIndex(prev => (prev + 1) % shuffledCategories.length);
    setRoundCompleted(true);
  };

  const fiveSecondFail = () => {
    setFiveSecondScore(prev => ({ success: prev.success, total: prev.total + 1 }));
    setFiveSecondTimerActive(false);
    setCategoryIndex(prev => (prev + 1) % shuffledCategories.length);
    setRoundCompleted(true);
  };

  const nextPrompt = () => {
    setCurrentPromptIndex(prev => (prev + 1) % wouldYouRatherQuestions.length);
  };

  const renderGameSelection = () => {
    return (
      <div className="space-y-6 animate-in fade-in duration-500">
        {/* Hero section with professional polish */}
        <div className="text-center space-y-3 py-4">
          <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border border-cyan-500/30 mb-2 animate-in zoom-in duration-300">
            <Sparkles className="w-4 h-4 text-cyan-400" />
            <span className="text-cyan-400 text-sm font-bold">{games.length} ألعاب تفاعلية</span>
          </div>
          <h2 className="text-3xl font-bold text-white leading-tight animate-in slide-in-from-top duration-300">
            اختر لعبتك المفضلة
          </h2>
          <p className="text-slate-400 text-sm max-w-sm mx-auto leading-relaxed animate-in slide-in-from-top duration-300" style={{animationDelay: '100ms'}}>
            كل لعبة مصممة لمساعدتك على التعرف على مجموعتك بطريقة ممتعة وتفاعلية
          </p>
        </div>

        {/* Premium, themed game cards with stagger animation */}
        <div className="grid grid-cols-1 gap-4">
          {games.map((game, index) => {
            const theme = gameThemes[game.id] || gameThemes.default;
            return (
              <div 
                key={game.id}
                className="animate-in slide-in-from-right duration-300"
                style={{animationDelay: `${index * 100}ms`}}
              >
                <div 
                  className={`group relative bg-gradient-to-br from-slate-900/90 to-slate-900/80 backdrop-blur-xl rounded-2xl p-5 border ${theme.cardBorder} ${theme.cardBorderHover} transition-all duration-500 cursor-pointer shadow-xl hover:shadow-2xl transform hover:scale-[1.02] hover:-translate-y-1 active:scale-[0.98] overflow-hidden`} 
                  onClick={() => startGame(game.id)}
                >
                  {/* Background gradient effect */}
                  <div className={`absolute inset-0 bg-gradient-to-br ${game.color} opacity-0 group-hover:opacity-10 transition-opacity duration-500`}></div>
                  {/* Themed overlay tint */}
                  <div className={`pointer-events-none absolute inset-0 bg-gradient-to-br ${theme.cardOverlay} opacity-80 mix-blend-screen`}></div>
                  
                  {/* Decorative soft lights */}
                  <div className="absolute -top-14 -right-14 w-40 h-40 bg-white/5 rounded-full blur-3xl"></div>
                  <div className="absolute -bottom-16 -left-16 w-44 h-44 bg-white/5 rounded-full blur-3xl"></div>

                  {/* Recommended / New badges */}
                  {index === 0 && (
                    <div className="absolute top-2 left-2 z-10">
                      <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg border border-white/20 animate-pulse flex items-center gap-1">
                        <Star className="w-2.5 h-2.5 fill-current" />
                        <span>موصى به</span>
                      </div>
                    </div>
                  )}
                  {game.id === 'what-would-you-do' && (
                    <div className="absolute top-2 left-2 z-10">
                      <div className="bg-gradient-to-r from-cyan-400 to-blue-600 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg border border-white/20 animate-pulse flex items-center gap-1">
                        <Star className="w-2.5 h-2.5 fill-current" />
                        <span>لعبة جديدة</span>
                      </div>
                    </div>
                  )}

                  <div className="relative z-10 flex items-start gap-4">
                    {/* Icon with aura */}
                    <div className={`w-16 h-16 flex-shrink-0 rounded-2xl bg-gradient-to-br ${game.color} flex items-center justify-center text-white shadow-lg transition-all duration-300 group-hover:scale-110 group-hover:shadow-xl group-hover:rotate-3 ${theme.iconRing}`}>
                      {game.icon}
                    </div>

                    {/* Content */}
                    <div className="flex-1 min-w-0">
                      <h3 className="text-xl font-bold text-white mb-2 group-hover:text-transparent group-hover:bg-clip-text group-hover:bg-gradient-to-r group-hover:from-white group-hover:to-white/80 transition-all duration-300">
                        {game.nameAr}
                      </h3>
                      <p className="text-slate-300 text-sm leading-relaxed mb-3">
                        {game.descriptionAr}
                      </p>

                      {/* Meta chips */}
                      <div className="flex items-center gap-2 mb-3">
                        <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full ${theme.chip}`}>
                          <Clock className="w-3.5 h-3.5" />
                          <span className="text-xs font-medium">{game.duration} دقائق</span>
                        </div>
                        <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full ${theme.chip}`}>
                          <Users className="w-3.5 h-3.5" />
                          <span className="text-xs font-medium">3-6 أشخاص</span>
                        </div>
                      </div>

                      {/* CTA */}
                      <div className="flex items-center justify-end">
                        <button
                          onClick={(e) => { e.stopPropagation(); startGame(game.id); }}
                          className={`inline-flex items-center gap-2 bg-gradient-to-r ${theme.cta} text-white px-4 py-2 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 border border-white/10`}
                          aria-label="ابدأ اللعبة"
                        >
                          <span className="text-sm font-bold">ابدأ اللعبة</span>
                          <ChevronLeft className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Bottom help text with fade-in animation */}
        <div className="text-center pt-4 pb-2 animate-in fade-in duration-500" style={{animationDelay: '600ms'}}>
          <p className="text-xs text-slate-500 flex items-center justify-center gap-2">
            <Lightbulb className="w-4 h-4" />
            <span>نصيحة: يمكنك التبديل بين الألعاب في أي وقت</span>
          </p>
        </div>
      </div>
    );
  };

  const renderGameContent = () => {
    if (!selectedGameId) {
      return renderGameSelection();
    }

    const currentGame = games.find(g => g.id === selectedGameId);
    if (!currentGame) return null;

    if (gamePhase === "completed") {
      return (
        <div className="text-center space-y-6">
          <div className="w-20 h-20 mx-auto rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white">
            <Trophy className="w-10 h-10" />
          </div>
          <div>
            <h2 className="text-3xl font-bold text-white mb-2">انتهت اللعبة!</h2>
            <p className="text-slate-300 text-lg">أحسنتم! وقت للعبة التالية</p>
          </div>
          {currentGameIndex < games.length - 1 ? (
            <Button 
              onClick={nextGame}
              className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-8 py-3 text-lg"
            >
              <ChevronRight className="w-5 h-5 mr-2" />
              اللعبة التالية
            </Button>
          ) : (
            <div className="space-y-4">
              <div className="flex items-center justify-center gap-3 mb-4">
                <PartyPopper className="w-8 h-8 text-yellow-400" />
                <h3 className="text-2xl font-bold text-white">انتهت جميع الألعاب!</h3>
                <PartyPopper className="w-8 h-8 text-yellow-400" />
              </div>
              <p className="text-slate-300">شكراً لكم على المشاركة الرائعة!</p>
            </div>
          )}
        </div>
      );
    }

    // Playing phase
    return (
      <div className="space-y-6">
        <div className="text-center">
          <div className="flex items-center justify-center space-x-4 mb-4">
          </div>
        </div>

        {currentGame.id === "discussion-questions" && (
          <Card className="bg-slate-800/50 border-slate-700">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <h3 className="text-2xl font-bold text-white mb-4">
                  أسئلة للنقاش العميق
                </h3>
                <p className="text-slate-300 mb-4">
                  اختر موضوعاً وليجب كل مشارك على السؤال بالدور
                </p>
              </div>
              
              {/* Game Instructions */}
              <div className="bg-slate-700/30 rounded-lg p-4 mb-6">
                <h4 className="text-white font-semibold mb-3 flex items-center">
                  <Lightbulb className="w-4 h-4 ml-2" />
                  كيفية اللعب:
                </h4>
                <ol className="text-slate-300 text-sm space-y-2 list-decimal list-inside">
                  <li>اختاروا موضوعاً من القائمة أدناه</li>
                  <li>اقرؤوا السؤال بصوت عالٍ</li>
                  <li>يجيب كل شخص بالدور (2-3 دقائق لكل شخص)</li>
                  <li>استمعوا باهتمام ولا تقاطعوا المتحدث</li>
                  <li>يمكنكم طرح أسئلة متابعة بعد انتهاء الجميع</li>
                </ol>
              </div>

              <div className="text-center">
                <Button 
                  onClick={() => setShowPromptTopicsModal(true)}
                  className="bg-gradient-to-r from-cyan-700 to-blue-700 hover:from-cyan-800 hover:to-blue-800 text-white px-6 py-3 rounded-2xl shadow-lg font-bold text-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 border-2 border-cyan-400/30"
                >
                  <Sparkles className="w-5 h-5 mr-2" />
                  اختر أسئلة للنقاش
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {currentGame.id === "never-have-i-ever" && (
          <Card className="bg-slate-900/60 border-violet-600/30">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-violet-500/20 border border-violet-400/30 mb-3">
                  <Target className="w-4 h-4 text-violet-300" />
                  <span className="text-violet-200 text-xs font-bold">تجارب شخصية</span>
                </div>
                <h3 className="text-3xl font-extrabold text-white mb-2">لم أفعل من قبل</h3>
                <p className="text-slate-300">شاركوا تجاربكم الشخصية العميقة</p>
              </div>

              {/* Enhanced Game Instructions */}
              <div className="bg-gradient-to-r from-violet-700/30 to-fuchsia-700/30 rounded-xl p-6 mb-8 border border-violet-600/50">
                <h4 className="text-white font-bold text-lg mb-4 flex items-center">
                  <Lightbulb className="w-5 h-5 ml-3 text-violet-300" />
                  كيفية اللعب:
                </h4>
                <ol className="text-violet-100/90 space-y-3 list-decimal list-inside">
                  <li className="flex items-start">
                    <span className="font-medium">اقرؤوا العبارة بصوت عالٍ</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">إذا فعلت هذا الشيء من قبل، ارفع يدك وشارك تجربتك (دقيقة واحدة)</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">إذا لم تفعله من قبل، ابق صامتاً</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">لا تجبروا أحداً على المشاركة إذا لم يرد</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">احترموا خصوصية بعضكم البعض</span>
                  </li>
                </ol>
              </div>

              <div className="bg-gradient-to-br from-violet-500/15 to-fuchsia-600/15 rounded-2xl p-6 mb-6 text-center border border-violet-500/30 shadow-xl">
                <p className="text-white text-xl font-semibold leading-relaxed">
                  {shuffledNeverHaveIEver.length > 0 
                    ? shuffledNeverHaveIEver[currentPromptIndex % shuffledNeverHaveIEver.length]
                    : neverHaveIEverQuestions[currentPromptIndex % neverHaveIEverQuestions.length]
                  }
                </p>
              </div>

              <div className="flex justify-center space-x-3 mt-8">
                <Button 
                  onClick={() => setCurrentPromptIndex(prev => (prev + 1) % (shuffledNeverHaveIEver.length || neverHaveIEverQuestions.length))} 
                  className="bg-gradient-to-r from-violet-600 to-fuchsia-700 hover:from-violet-700 hover:to-fuchsia-800 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                >
                  <ChevronRight className="w-5 h-5 mr-2" />
                  السؤال التالي
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {currentGame.id === "what-would-you-do" && (
          <Card className="bg-slate-900/60 border-indigo-600/30">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/20 border border-indigo-400/30 mb-3">
                  <MessageSquare className="w-4 h-4 text-indigo-300" />
                  <span className="text-indigo-200 text-xs font-bold">سيناريو</span>
                </div>
                <h3 className="text-3xl font-extrabold text-white mb-2">ماذا تفعل لو؟</h3>
                <p className="text-indigo-100/90">سيناريوهات متوسطة إلى عميقة لتحفيز نقاش قيَمي وقرارات واعية</p>
              </div>

              {/* Game Instructions */}
              <div className="bg-gradient-to-r from-indigo-700/40 to-blue-700/40 rounded-xl p-6 mb-8 border border-indigo-600/50">
                <h4 className="text-white font-bold text-lg mb-4 flex items-center">
                  <Lightbulb className="w-5 h-5 ml-3 text-indigo-300" />
                  كيفية اللعب:
                </h4>
                <ol className="text-indigo-100/90 space-y-3 list-decimal list-inside">
                  <li className="flex items-start">
                    <span className="font-medium">اقرؤوا السيناريو بصوت عالٍ. لا توجد إجابة صحيحة/خاطئة.</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">كل شخص يشارك موقفه ودوافعه (1–2 دقيقة لكل شخص).</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">اسألوا سؤال متابعة واحد على الأقل يوضح القيم/المعايير وراء القرار.</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">اختتموا بجملة واحدة: "ما المبدأ الذي قاد قراري هنا؟"</span>
                  </li>
                </ol>
              </div>

              <div className="bg-gradient-to-r from-indigo-500/20 to-blue-500/20 border-2 border-indigo-500/40 rounded-2xl p-8 text-center shadow-2xl">
                <p className="text-white text-xl font-semibold leading-relaxed">
                  {shuffledWhatWouldYouDo.length > 0
                    ? shuffledWhatWouldYouDo[currentPromptIndex % shuffledWhatWouldYouDo.length]
                    : whatWouldYouDoScenarios[currentPromptIndex % whatWouldYouDoScenarios.length]}
                </p>
              </div>

              <div className="flex justify-center mt-8">
                <Button
                  onClick={() => {
                    const len = (shuffledWhatWouldYouDo.length || whatWouldYouDoScenarios.length);
                    setCurrentPromptIndex(prev => (prev + 1) % len);
                  }}
                  className="bg-gradient-to-r from-indigo-600 to-blue-700 hover:from-indigo-700 hover:to-blue-800 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                >
                  <ChevronRight className="w-5 h-5 mr-2" />
                  السؤال التالي
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {currentGame.id === "two-truths-lie" && (
          <Card className="bg-slate-800/50 border-slate-700">
            <CardContent className="p-6 text-center">
              <div className="space-y-4 text-slate-300">
                <p>قل ثلاث عبارات عن نفسك:</p>
                <ul className="list-disc list-inside space-y-2">
                  <li>حقيقة أولى</li>
                  <li>حقيقة ثانية</li>
                  <li>كذبة واحدة</li>
                </ul>
                <p className="text-sm">على الآخرين تخمين أي عبارة كاذبة!</p>
              </div>
            </CardContent>
          </Card>
        )}

        {currentGame.id === "5-second-rule" && (
          <Card className="bg-slate-900/60 border-orange-600/30">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-orange-500/20 border border-orange-400/30 mb-3">
                  <Timer className="w-4 h-4 text-orange-300" />
                  <span className="text-orange-200 text-xs font-bold">تحدي السرعة</span>
                </div>
                <h3 className="text-3xl font-extrabold text-white mb-1">قاعدة الخمس ثواني</h3>
                <p className="text-orange-100/90">سمّ 3 أشياء قبل انتهاء الوقت!</p>
              </div>

              {/* Game Instructions */}
              <div className="bg-gradient-to-r from-orange-700/40 to-red-700/40 rounded-xl p-6 mb-8 border border-orange-600/50">
                <h4 className="text-white font-bold text-lg mb-4 flex items-center">
                  <Lightbulb className="w-5 h-5 ml-3 text-orange-400" />
                  كيفية اللعب:
                </h4>
                <ol className="text-slate-200 space-y-3 list-decimal list-inside">
                  <li className="flex items-start">
                    <span className="font-medium">شخص واحد يضغط "ابدأ" ويقرأ الفئة بصوت عالٍ</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">عليه تسمية 3 أشياء من الفئة خلال 5 ثوان فقط!</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">إذا نجح: اضغطوا "نجح ✓" - إذا فشل: اضغطوا "فشل ✗"</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">تناوبوا بين أعضاء المجموعة - الجميع يلعب</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">لا يمكن تكرار نفس الإجابة مرتين!</span>
                  </li>
                </ol>
              </div>

              {/* Score Display */}
              <div className="flex justify-center mb-6">
                <div className="bg-gradient-to-r from-orange-700/50 to-red-700/50 rounded-xl px-6 py-3 border border-orange-500/30 shadow-lg">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-orange-300">
                      {fiveSecondScore.success}/{fiveSecondScore.total}
                    </div>
                    <div className="text-orange-200 text-sm font-medium">نجاحات</div>
                  </div>
                </div>
              </div>

              {/* Current Category Display */}
              {currentCategory && (
                <div className="mb-8">
                  <div className="bg-gradient-to-r from-orange-500/20 to-red-500/20 border-2 border-orange-500/40 rounded-2xl p-8 text-center shadow-2xl">
                    {/* Category Title */}
                    <div className="mb-6">
                      <div className="inline-block bg-orange-500/30 px-4 py-2 rounded-full mb-3">
                        <span className="text-orange-300 text-sm font-bold">{isReadingPhase ? 'اقرأ الفئة' : 'الفئة'}</span>
                      </div>
                      <h4 className="text-4xl font-bold text-white mb-2">
                        {currentCategory}
                      </h4>
                      <p className="text-orange-200 text-lg">{isReadingPhase ? 'استعد... سمّ 3 أشياء!' : 'سمّ 3 أشياء!'}</p>
                    </div>
                    
                    {/* Timer Display */}
                    <div className="mb-6">
                      {isReadingPhase ? (
                        // Reading phase timer
                        <>
                          <div className="text-6xl font-black text-blue-400 mb-2 drop-shadow-[0_0_10px_rgba(59,130,246,0.35)]">
                            {readingTimer}
                          </div>
                          <p className="text-blue-300 text-sm mb-2">ثانية للقراءة</p>
                          <Progress 
                            value={(readingTimer / 3) * 100} 
                            className="w-full mt-4 h-3"
                          />
                        </>
                      ) : (
                        // Game timer
                        <>
                          <div className={`text-8xl font-black transition-all duration-300 drop-shadow-[0_0_12px_rgba(255,255,255,0.2)] ${
                            fiveSecondTimer <= 2 ? 'text-red-400 animate-pulse scale-110' : 
                            fiveSecondTimer <= 3 ? 'text-orange-400' : 'text-green-400'
                          }`}>
                            {fiveSecondTimer}
                          </div>
                          <Progress 
                            value={(fiveSecondTimer / 5) * 100} 
                            className="w-full mt-4 h-3"
                          />
                        </>
                      )}
                    </div>

                    {/* Action Buttons - Only show when timer is stopped */}
                    {!fiveSecondTimerActive && fiveSecondTimer === 0 && (
                      <div className="flex justify-center gap-3 mt-6">
                        <Button 
                          onClick={fiveSecondSuccess}
                          className="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-4 py-2 text-base font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200"
                        >
                          <CheckCircle className="w-4 h-4 mr-1.5" />
                          نجح
                        </Button>
                        <Button 
                          onClick={fiveSecondFail}
                          className="bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white px-4 py-2 text-base font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200"
                        >
                          <XCircle className="w-4 h-4 mr-1.5" />
                          فشل
                        </Button>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Start Round Button */}
              {!currentCategory || (!fiveSecondTimerActive && fiveSecondTimer === 0 && roundCompleted) ? (
                <div className="text-center">
                  <Button 
                    onClick={startFiveSecondRound}
                    className="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-10 py-5 text-2xl font-black rounded-2xl shadow-2xl hover:shadow-orange-500/25 transition-all duration-300 transform hover:scale-110 animate-pulse"
                  >
                    <Timer className="w-8 h-8 mr-3" />
                    {currentCategory ? 'الفئة التالية' : 'ابدأ اللعبة!'}
                  </Button>
                  
                  {/* Category Progress */}
                  {shuffledCategories.length > 0 && (
                    <div className="mt-4 text-slate-400 text-sm">
                      الفئة {categoryIndex + 1} من {shuffledCategories.length}
                    </div>
                  )}
                </div>
              ) : null}
            </CardContent>
          </Card>
        )}

        {currentGame.id === "imposter" && (
          <Card className="bg-slate-900/60 border-fuchsia-600/30">
            <CardContent className="p-6">
              {/* Phase indicator + actions */}
              {(() => {
                const steps = [
                  { key: 'setup', label: 'إعداد' },
                  { key: 'reveal', label: 'كشف' },
                  { key: 'discussion', label: 'أسئلة' },
                  { key: 'voting', label: 'تصويت' },
                  { key: 'result', label: 'نتيجة' },
                ] as const;
                const activeIdx = steps.findIndex(s => s.key === imposterPhase);
                return (
                  <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                    <div className="flex items-center gap-1.5 flex-wrap">
                      {steps.map((s, i) => (
                        <div
                          key={s.key}
                          className={`px-2 py-0.5 rounded-full text-[11px] font-semibold border whitespace-nowrap ${i <= activeIdx ? 'bg-fuchsia-500/20 border-fuchsia-400/40 text-fuchsia-100' : 'bg-white/5 border-white/10 text-slate-300'}`}
                        >
                          {s.label}
                        </div>
                      ))}
                    </div>
                    <div className="flex sm:justify-end">
                      <button
                        onClick={() => setImposterShowTutorial(true)}
                        className="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-white/5 hover:bg-white/10 border border-white/10 text-white text-xs shrink-0"
                      >
                        <BookOpen className="w-3.5 h-3.5" />
                        <span className="hidden sm:inline">تعليمات</span>
                      </button>
                    </div>
                  </div>
                );
              })()}
              {imposterPhase === "setup" && (
                <div className="space-y-6">
                  <div className="text-center mb-2">
                    <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-fuchsia-500/20 border border-fuchsia-400/30 mb-3">
                      <Ghost className="w-4 h-4 text-fuchsia-300" />
                      <span className="text-fuchsia-200 text-xs font-bold">لعبة تخمين</span>
                    </div>
                    <h3 className="text-3xl font-extrabold text-white mb-1">الأمبوستر</h3>
                    <p className="text-fuchsia-100/90">أدخل الأسماء (4–6)، اختر فئة، ثم ابدأ الجولة</p>
                  </div>

                  {/* Names input */}
                  <div className={`${(gameThemes['imposter'] || gameThemes.default).instruction} space-y-4`}>
                    <h4 className="text-white font-bold mb-3">أسماء اللاعبين</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {imposterPlayers.map((n, i) => (
                        <div key={`name-${i}`} className="flex items-center gap-2 min-w-0">
                          <input
                            className="flex-1 min-w-0 px-3 py-2 rounded-lg bg-slate-800/70 border border-white/10 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-500/40"
                            placeholder={`اللاعب ${i+1}`}
                            value={n}
                            onChange={e => {
                              const arr = [...imposterPlayers]; arr[i] = e.target.value; setImposterPlayers(arr); setImposterError(null);
                            }}
                          />
                          {imposterPlayers.length > 4 && (
                            <button
                              onClick={() => { setImposterPlayers(prev => prev.filter((_, idx) => idx !== i)); setImposterError(null); }}
                              className="w-9 h-9 inline-flex items-center justify-center rounded-lg bg-rose-500/20 text-rose-200 border border-rose-400/30 hover:bg-rose-500/30"
                              title="حذف"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mt-3">
                      <button
                        onClick={() => { if (imposterPlayers.length < 6) setImposterPlayers(prev => [...prev, ""]); setImposterError(null); }}
                        disabled={imposterPlayers.length >= 6}
                        className="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-fuchsia-500/20 text-fuchsia-100 border border-fuchsia-400/30 hover:bg-fuchsia-500/30 disabled:opacity-50 w-full sm:w-auto"
                      >
                        <Plus className="w-4 h-4" />
                        أضف لاعباً
                      </button>
                      <span className="text-slate-300 text-xs">الحد: 4–6 لاعبين</span>
                    </div>
                  </div>

                  {/* Inline validation */}
                  {imposterError && (
                    <div className="-mt-2 mb-2 text-sm text-rose-300 bg-rose-500/10 border border-rose-400/30 rounded-lg px-3 py-2">
                      {imposterError}
                    </div>
                  )}

                  {/* Category */}
                  <div className={`${(gameThemes['imposter'] || gameThemes.default).instruction} space-y-4`}>
                    <h4 className="text-white font-bold mb-3">الفئة</h4>
                    <div className="relative">
                      <ChevronDown className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-fuchsia-300 pointer-events-none" />
                      <select
                        className="w-full appearance-none pl-9 pr-3 py-2.5 rounded-xl bg-slate-800/70 border-2 border-fuchsia-400/30 text-white focus:outline-none focus:ring-2 focus:ring-fuchsia-500/50 focus:border-fuchsia-400/60 shadow-inner"
                        value={imposterSelectedCategory}
                        onChange={(e) => { setImposterSelectedCategory(e.target.value); setImposterError(null); }}
                      >
                        {Object.keys(imposterCategories).map(cat => (
                          <option key={cat} value={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                    <div className="text-xs text-slate-300">اختر فئة بكلمات يومية سهلة للتحدي الممتع</div>
                  </div>

                  <div className="text-center">
                    <Button onClick={startImposterRound} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-8 py-4 text-lg font-bold rounded-2xl shadow-lg hover:shadow-xl transition-all">
                      ابدأ الجولة
                    </Button>
                  </div>
                </div>
              )}

              {imposterPhase === "reveal" && (
                <div className="space-y-6">
                  <div className="text-center mb-2">
                    <h3 className="text-2xl font-extrabold text-white mb-1">كشف الأدوار</h3>
                    <p className="text-fuchsia-100/90">سلّم الهاتف إلى <span className="font-bold text-white">{imposterPlayers[revealIndex]}</span></p>
                  </div>

                  <div className={(gameThemes['imposter'] || gameThemes.default).promptCard}>
                    {!revealShown ? (
                      <div className="space-y-4">
                        <p className="text-fuchsia-100/90">اضغط للكشف. لا تري أحداً غيرك 🤫</p>
                        <Button onClick={nextReveal} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-6 py-3 rounded-xl font-bold">
                          اكشف الآن
                        </Button>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {revealIndex === imposterIndex ? (
                          <>
                            <div className="text-4xl font-black text-rose-300">أنت الأمبوستر</div>
                            <p className="text-rose-200">لا تعرف الكلمة. حاول الاندماج!</p>
                          </>
                        ) : (
                          <>
                            <div className="text-3xl font-extrabold text-white">كلمتك:</div>
                            <div className="text-4xl font-black text-fuchsia-200">{imposterSecretWord}</div>
                            <p className="text-fuchsia-100/90">قل كلمة ذات صلة بدون كشف مباشر</p>
                          </>
                        )}
                        <Button onClick={nextReveal} className="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-semibold border border-white/15">
                          إخفاء وتسليم الهاتف ↗
                        </Button>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {imposterPhase === "discussion" && (
                <div className="space-y-6">
                  <div className="text-center">
                    <h3 className="text-2xl font-extrabold text-white mb-2">أسئلة نعم/لا</h3>
                    <p className="text-fuchsia-100/90">كل لاعب يسأل مرة ويُسأل مرة — بالتتابع وبترتيب عشوائي عادل</p>
                  </div>

                  {qaPairs.length > 0 && (
                    <>
                      {/* Handover banner: who holds the phone */}
                      <div className="flex items-center justify-center mb-2">
                        <span className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-fuchsia-500/20 border border-fuchsia-400/30 text-xs text-fuchsia-100">
                          <Smartphone className="w-4 h-4" />
                          سلّم الهاتف إلى <span className="font-bold text-white">{imposterPlayers[qaPairs[qaIndex].asker] || `لاعب ${qaPairs[qaIndex].asker + 1}`}</span>
                        </span>
                      </div>

                      <div className={(gameThemes['imposter'] || gameThemes.default).promptCard}>
                        {/* Clear direction: A asks B */}
                        <div className="text-center text-lg font-extrabold text-white mb-2">
                          <span className="text-fuchsia-300">{imposterPlayers[qaPairs[qaIndex].asker]}</span>
                          <span className="mx-2 text-slate-300">يسأل</span>
                          <span className="text-purple-300">{imposterPlayers[qaPairs[qaIndex].target]}</span>
                        </div>

                        <div className="flex items-center justify-center gap-3 mb-3">
                          <Badge className="bg-fuchsia-500/25 border-fuchsia-400/40 text-fuchsia-100 border">
                            السائل: {imposterPlayers[qaPairs[qaIndex].asker]}
                          </Badge>
                          <ChevronLeft className="w-4 h-4 text-slate-300" />
                          <Badge className="bg-purple-500/25 border-purple-400/40 text-purple-100 border">
                            الهدف: {imposterPlayers[qaPairs[qaIndex].target]}
                          </Badge>
                        </div>

                        <div className="text-slate-200 mb-4">اطرح سؤالاً قصيراً بنعم/لا دون كشف مباشر</div>
                        <div className="text-center">
                          {qaIndex < qaPairs.length - 1 ? (
                            <Button onClick={() => setQAIndex(qaIndex + 1)} className="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-semibold border border-white/15">
                              بعد الإجابة • التالي
                            </Button>
                          ) : (
                            <Button onClick={startVoting} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-8 py-3 rounded-xl font-bold">
                              ابدأ التصويت
                            </Button>
                          )}
                        </div>
                        <div className="mt-3 text-xs text-slate-300">دور {qaIndex + 1} من {qaPairs.length}</div>
                      </div>
                    </>
                  )}
                </div>
              )}

              {imposterPhase === "voting" && (
                <div className="space-y-6">
                  <div className="text-center mb-2">
                    <h3 className="text-2xl font-extrabold text-white mb-1">تصويت سري</h3>
                    <p className="text-fuchsia-100/90">سلّم الهاتف إلى <span className="font-bold text-white">{imposterPlayers[voteTurn]}</span> لاختيار المشتبه</p>
                  </div>
                  <div className={(gameThemes['imposter'] || gameThemes.default).instruction}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {imposterPlayers.map((n, idx) => (
                        idx === voteTurn ? null : (
                          <button
                            key={`vote-${idx}`}
                            onClick={() => castVote(idx)}
                            className="w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white transition-colors"
                          >
                            {n || `لاعب ${idx+1}`}
                          </button>
                        )
                      ))}
                    </div>
                  </div>
                  <div className="text-center text-slate-300 text-sm">المصوّت {voteTurn + 1} من {imposterPlayers.length}</div>
                </div>
              )}

              {imposterPhase === "result" && accusedIndex !== null && (
                <div className="space-y-6 text-center">
                  {accusedIndex === imposterIndex ? (
                    <>
                      <div className="w-20 h-20 mx-auto rounded-full bg-gradient-to-r from-emerald-500 to-green-600 flex items-center justify-center text-white shadow-xl">
                        <CheckCircle className="w-10 h-10" />
                      </div>
                      <h3 className="text-3xl font-extrabold text-white">أحسنتم! اكتشفتم الأمبوستر</h3>
                      <p className="text-fuchsia-100/90">الكلمة كانت: <span className="text-white font-bold">{imposterSecretWord}</span></p>
                    </>
                  ) : (
                    <>
                      <div className="w-20 h-20 mx-auto rounded-full bg-gradient-to-r from-rose-500 to-red-600 flex items-center justify-center text-white shadow-xl">
                        <XCircle className="w-10 h-10" />
                      </div>
                      <h3 className="text-3xl font-extrabold text-white">فاز الأمبوستر هذه الجولة</h3>
                      <p className="text-fuchsia-100/90">كان الأمبوستر: <span className="text-white font-bold">{imposterPlayers[imposterIndex]}</span> • الكلمة: <span className="text-white font-bold">{imposterSecretWord}</span></p>
                    </>
                  )}

                  {/* Reveal all roles */}
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                    {imposterPlayers.map((n, idx) => (
                      <div key={`rev-${idx}`} className="px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white flex items-center justify-between">
                        <span>{n || `لاعب ${idx+1}`}</span>
                        <Badge className={`${idx === imposterIndex ? 'bg-rose-500/30 border-rose-400/40 text-rose-100' : 'bg-emerald-500/30 border-emerald-400/40 text-emerald-100'} border` }>
                          {idx === imposterIndex ? 'الأمبوستر' : 'مدني'}
                        </Badge>
                      </div>
                    ))}
                  </div>

                  <div className="flex items-center justify-center gap-3 mt-4">
                    <Button onClick={newImposterRound} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-6 py-3 rounded-xl font-bold">
                      جولة جديدة
                    </Button>
                    <Button onClick={resetImposter} className="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-semibold border border-white/15">
                      تعديل الأسماء/الفئة
                    </Button>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Imposter Tutorial Overlay */}
        {selectedGameId === 'imposter' && imposterShowTutorial && (
          <div 
            className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
            style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0 }}
          >
            <div className="w-full max-w-sm bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-slate-700 shadow-2xl p-5 text-white" dir="rtl">
              <div className="flex items-center justify-between mb-2">
                <div className="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-fuchsia-500/20 border border-fuchsia-400/30 text-xs text-fuchsia-100">
                  <HelpCircle className="w-3.5 h-3.5" /> دليل اللعبة
                </div>
                <button onClick={() => setImposterShowTutorial(false)} className="text-slate-300 hover:text-white">✕</button>
              </div>
              <div className="mb-3 font-extrabold text-lg">الأمبوستر — كيف نلعب؟</div>
              <div className="text-slate-200 text-sm min-h-[130px] space-y-2">
                {imposterTutorialSlide === 0 && (
                  <div>
                    <p>لعبة جماعية على هاتف واحد. توجد <span className="text-fuchsia-300 font-semibold">كلمة سرية</span> للجميع، وشخص واحد هو <span className="text-rose-300 font-semibold">الأمبوستر</span> لا يعرفها.</p>
                    <p>هدف المدنيين: اكتشاف الأمبوستر. هدف الأمبوستر: الاندماج دون انكشاف.</p>
                  </div>
                )}
                {imposterTutorialSlide === 1 && (
                  <div>
                    <p className="font-semibold">الإعداد</p>
                    <ul className="list-disc list-inside text-slate-300 space-y-1">
                      <li>أدخلوا أسماء <span className="text-white">4–6 لاعبين</span>.</li>
                      <li>اختاروا <span className="text-white">فئة</span> للكلمة السرية.</li>
                      <li>ابدؤوا الجولة.</li>
                    </ul>
                  </div>
                )}
                {imposterTutorialSlide === 2 && (
                  <div>
                    <p className="font-semibold">كشف الأدوار</p>
                    <ul className="list-disc list-inside text-slate-300 space-y-1">
                      <li>يمسك كل لاعب الهاتف ويضغط لكشف دوره سراً.</li>
                      <li>المدني يرى الكلمة. الأمبوستر يرى أنه محتال ولا يعرف الكلمة.</li>
                      <li>سلّم الهاتف للاعب التالي حتى ينتهي الجميع.</li>
                    </ul>
                  </div>
                )}
                {imposterTutorialSlide === 3 && (
                  <div>
                    <p className="font-semibold">أسئلة ثم تصويت</p>
                    <ul className="list-disc list-inside text-slate-300 space-y-1">
                      <li>الجولة توجه <span className="text-white">أسئلة نعم/لا</span> بين لاعبين عشوائياً.</li>
                      <li>بعد عدة أدوار، <span className="text-white">تصويت سري</span> لاختيار المشتبه.</li>
                      <li>تظهر النتيجة والأدوار، ويمكن بدء جولة جديدة.</li>
                    </ul>
                  </div>
                )}
              </div>
              <div className="flex items-center justify-between mt-4">
                <div className="flex items-center gap-1">
                  {[0,1,2,3].map(i => (
                    <span key={i} className={`w-2 h-2 rounded-full ${imposterTutorialSlide === i ? 'bg-fuchsia-400' : 'bg-white/25'}`}></span>
                  ))}
                </div>
                <div className="flex items-center gap-2">
                  {imposterTutorialSlide > 0 && (
                    <Button onClick={() => setImposterTutorialSlide(imposterTutorialSlide - 1)} className="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg border border-white/15">
                      السابق
                    </Button>
                  )}
                  {imposterTutorialSlide < 3 ? (
                    <Button onClick={() => setImposterTutorialSlide(imposterTutorialSlide + 1)} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-3 py-1 rounded-lg">
                      التالي
                    </Button>
                  ) : (
                    <>
                      <Button onClick={() => { setImposterShowTutorial(false); }} className="bg-gradient-to-r from-fuchsia-600 to-purple-700 hover:from-fuchsia-700 hover:to-purple-800 text-white px-3 py-1 rounded-lg">
                        فهمت
                      </Button>
                      <Button onClick={() => { try { localStorage.setItem('imposter_tutorial_seen', '1'); } catch {}; setImposterShowTutorial(false); }} className="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg border border-white/15">
                        لا تظهر مرة أخرى
                      </Button>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {currentGame.id === "would-you-rather" && (
          <Card className="bg-slate-900/60 border-rose-600/30">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-rose-500/20 border border-rose-400/30 mb-3">
                  <Heart className="w-4 h-4 text-rose-300" />
                  <span className="text-rose-200 text-xs font-bold">مفاضلة</span>
                </div>
                <h3 className="text-3xl font-extrabold text-white mb-1">ماذا تفضل؟</h3>
              </div>

              {/* Game Instructions */}
              <div className="bg-slate-700/30 rounded-xl p-6 mb-6 border border-slate-600/50">
                <h4 className="text-white font-semibold mb-3 flex items-center">
                  <Lightbulb className="w-4 h-4 ml-2" />
                  كيفية اللعب:
                </h4>
                <ol className="text-slate-300 text-sm space-y-2 list-decimal list-inside">
                  <li>اقرؤوا الخيارين بصوت عالٍ</li>
                  <li>كل شخص يختار أحد الخيارين</li>
                  <li>اشرحوا سبب اختياركم (دقيقة لكل شخص)</li>
                  <li>ناقشوا الاختلافات في وجهات النظر</li>
                  <li>لا يوجد إجابة صحيحة أو خاطئة</li>
                </ol>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div className="bg-gradient-to-br from-rose-500/15 to-red-600/10 border-2 border-rose-500/40 rounded-xl p-5 text-center shadow-lg">
                  <div className="text-rose-300 font-bold mb-2">الخيار أ</div>
                  <p className="text-white font-semibold leading-relaxed">
                    {(shuffledWouldYouRather.length > 0 
                      ? shuffledWouldYouRather[currentPromptIndex]
                      : wouldYouRatherQuestions[currentPromptIndex]
                    )?.optionA}
                  </p>
                </div>
                <div className="bg-gradient-to-br from-sky-500/15 to-blue-600/10 border-2 border-sky-500/40 rounded-xl p-5 text-center shadow-lg">
                  <div className="text-sky-300 font-bold mb-2">الخيار ب</div>
                  <p className="text-white font-semibold leading-relaxed">
                    {(shuffledWouldYouRather.length > 0 
                      ? shuffledWouldYouRather[currentPromptIndex]
                      : wouldYouRatherQuestions[currentPromptIndex]
                    )?.optionB}
                  </p>
                </div>
              </div>

              <div className="text-center">
                <Button 
                  onClick={nextPrompt} 
                  className="bg-gradient-to-r from-rose-600 to-red-700 hover:from-rose-700 hover:to-red-800 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                >
                  <ChevronRight className="w-5 h-5 mr-2" />
                  السؤال التالي
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {currentGame.id === "charades" && (
          <Card className="bg-slate-900/60 border-emerald-600/30">
            <CardContent className="p-6">
              <div className="text-center mb-6">
                <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/20 border border-emerald-400/30 mb-3">
                  <ThumbsUp className="w-4 h-4 text-emerald-300" />
                  <span className="text-emerald-200 text-xs font-bold">تمثيل</span>
                </div>
                <h3 className="text-3xl font-extrabold text-white mb-1">ولا كلمة</h3>
              </div>

              {/* Game Instructions */}
              <div className="bg-gradient-to-r from-slate-700/40 to-slate-600/40 rounded-xl p-6 mb-8 border border-slate-600/50">
                <h4 className="text-white font-bold text-lg mb-4 flex items-center">
                  <Lightbulb className="w-5 h-5 ml-3 text-emerald-300" />
                  كيفية اللعب:
                </h4>
                <ol className="text-emerald-100/90 space-y-3 list-decimal list-inside">
                  <li className="flex items-start">
                    <span className="font-medium">شخص واحد يقرأ الكلمة سراً (لا يقولها بصوت عالٍ)</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">يمثل الكلمة بالحركات فقط - ممنوع الكلام أو الأصوات</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">الباقي يحاولون تخمين الكلمة خلال دقيقة ونصف</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">إذا خمنوا صح: اضغطوا "صحيح" - إذا لم يخمنوا: اضغطوا "تخطي"</span>
                  </li>
                  <li className="flex items-start">
                    <span className="font-medium">تناوبوا الأدوار - كل شخص يمثل كلمة</span>
                  </li>
                </ol>
              </div>

              {/* Score Display */}
              <div className="flex justify-center mb-6">
                <div className="bg-slate-700/50 rounded-lg px-6 py-3 border border-emerald-500/30 shadow-lg">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-emerald-400">
                      {charadesScore.correct}/{charadesScore.total}
                    </div>
                    <div className="text-slate-300 text-sm">نقاط صحيحة</div>
                  </div>
                </div>
              </div>

              {/* Current Word Display */}
              {currentCharadesWord && (
                <div className="mb-8">
                  <div className="bg-gradient-to-r from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 rounded-xl p-6 text-center shadow-xl">
                    <div className="mb-2">
                      <span className="text-emerald-300 text-sm font-medium bg-emerald-500/20 px-3 py-1 rounded-full border border-emerald-400/30">
                        {currentCharadesCategory}
                      </span>
                    </div>
                    <div className="text-3xl font-bold text-white mb-4">
                      {currentCharadesWord}
                    </div>
                    
                    {/* Timer */}
                    <div className="mb-4">
                      <div className={`text-2xl font-bold ${
                        charadesTimer <= 15 ? 'text-red-400 animate-pulse drop-shadow-[0_0_8px_rgba(248,113,113,0.35)]' : 
                        charadesTimer <= 45 ? 'text-yellow-400 drop-shadow-[0_0_8px_rgba(251,191,36,0.35)]' : 'text-emerald-400 drop-shadow-[0_0_8px_rgba(16,185,129,0.35)]'
                      }`}>
                        {Math.floor(charadesTimer / 60)}:{(charadesTimer % 60).toString().padStart(2, '0')}
                      </div>
                      <Progress 
                        value={(charadesTimer / 90) * 100} 
                        className="w-full mt-2"
                      />
                    </div>

                    {/* Action Buttons */}
                    <div className="flex justify-center gap-4">
                      <Button 
                        onClick={charadesCorrect}
                        disabled={charadesTimer === 0}
                        className="bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                      >
                        <ThumbsUp className="w-5 h-5 mr-2" />
                        صحيح!
                      </Button>
                      <Button 
                        onClick={charadesSkip}
                        disabled={charadesTimer === 0}
                        className="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                      >
                        <SkipForward className="w-5 h-5 mr-2" />
                        تخطي
                      </Button>
                    </div>
                  </div>
                </div>
              )}

              {/* Start/Next Round Button */}
              {!currentCharadesWord && (
                <div className="text-center">
                  <Button 
                    onClick={startCharadesRound}
                    className="bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white px-8 py-4 text-xl font-bold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                  >
                    <Play className="w-6 h-6 mr-3" />
                    ابدأ الجولة
                  </Button>
                </div>
              )}

              {/* Next Round Button (when timer ends) */}
              {currentCharadesWord && charadesTimer === 0 && (
                <div className="text-center mt-6">
                  <Button 
                    onClick={startCharadesRound}
                    className="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
                  >
                    <ChevronRight className="w-5 h-5 mr-2" />
                    الكلمة التالية
                  </Button>
                </div>
              )}
            </CardContent>
          </Card>
        )}


      </div>
    );
  };

  // If groups page is locked, show a friendly locked page for everyone
  if (groupsLocked) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center px-4" dir="rtl">
        <div className="max-w-md w-full bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-8 shadow-2xl text-center">
          <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center shadow-lg">
            <Lock className="w-10 h-10 text-white" />
          </div>
          <h1 className="text-2xl sm:text-3xl font-extrabold text-white mb-3">الأنشطة الجماعية مقفلة الآن</h1>
          <p className="text-slate-300 mb-6">هذه الصفحة متاحة فقط للمشاركين الذين يختارهم المنظّم بناءً على نسبة التوافق. سيتم إشعار المختارين برسالة من المنظّم (غالبًا عبر واتساب) قبل بدء الأنشطة. ✨</p>

          <div className="grid grid-cols-1 gap-3 text-right mb-6">
            <div className="flex items-center gap-2 p-3 rounded-xl bg-emerald-500/10 border border-emerald-400/20">
              <CheckCircle className="w-4 h-4 text-emerald-400" />
              <span className="text-emerald-200 text-sm">تجربة تفاعلية ممتعة لمدة 45 دقيقة</span>
            </div>
            <div className="flex items-center gap-2 p-3 rounded-xl bg-cyan-500/10 border border-cyan-400/20">
              <CheckCircle className="w-4 h-4 text-cyan-400" />
              <span className="text-cyan-200 text-sm">رسالة دعوة ستصلك من المنظّم إذا تم اختيارك</span>
            </div>
            <div className="flex items-center gap-2 p-3 rounded-xl bg-purple-500/10 border border-purple-400/20">
              <CheckCircle className="w-4 h-4 text-purple-400" />
              <span className="text-purple-200 text-sm">لزيادة فرص اختيارك: أكمل بياناتك وتأكد من صحة رقمك</span>
            </div>
          </div>

          <div className="flex flex-col gap-3">
            <button
              onClick={() => (window.location.href = "/welcome")}
              className="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300"
            >
              العودة لصفحة الترحيب
            </button>
            <button
              onClick={() => window.location.reload()}
              className="w-full py-3 rounded-xl bg-white/10 hover:bg-white/15 border border-white/15 text-slate-200 transition-all"
            >
              تحديث الصفحة لاحقًا
            </button>
          </div>

          <div className="mt-6 text-xs text-slate-400">
            المجموعات ستفتح فقط للمشاركين الذين يرسل لهم المنظّم دعوة مباشرة. شكرًا لتفهمك.
          </div>
        </div>
      </div>
    );
  }

  // If user isn't confirmed (no token and no restored semi-login), show phone login screen
  if (dataLoaded && !isConfirmed) {
    return (
      <PhoneEntry onSubmit={submitPhoneDigits} loading={phoneLoading} error={phoneError} />
    );
  }

  if (!gameStarted) {
    return (
      <>
        {/* Prompt Topics Modal */}
      <PromptTopicsModal
        open={showPromptTopicsModal}
        onClose={() => setShowPromptTopicsModal(false)}
      />
      {/* Personalized onboarding after successful login */}
      {showOnboarding && (
        <OnboardingModal
          isOpen={showOnboarding}
          onClose={() => setShowOnboarding(false)}
          groupMembers={groupMembers}
          tableNumber={tableNumber}
          games={games.map(g => ({ id: g.id, nameAr: g.nameAr, color: g.color, icon: g.icon }))}
        />
      )}

      {/* Group Guide Popup - only show after onboarding closes */}
        {showGroupGuide && !showOnboarding && (
          <div 
            className="fixed z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-300"
            style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, width: '100vw', height: '100vh', zIndex: 9999 }}
            dir="rtl"
          >
            <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl shadow-2xl max-w-sm w-full border border-slate-700 relative overflow-hidden p-4 sm:p-6 animate-in zoom-in-95 duration-300 max-h-[80vh] sm:max-h-[75vh] overflow-y-auto custom-scrollbar">
              {/* Header */}
              <div className="text-center mb-4">
                <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
                  <Users className="w-6 h-6 text-white" />
                </div>
                <h2 className="text-lg font-bold text-white mb-1 flex items-center justify-center gap-2">
                  مرحباً بك في الأنشطة الجماعية!
                  <PartyPopper className="w-6 h-6 text-yellow-400" />
                </h2>
                <p className="text-slate-300 text-xs">
                  تجربة سريعة وممتعة مع مجموعتك
                </p>
              </div>

              {/* Instructions */}
              <div className="space-y-3 mb-4">
                <ul className="space-y-2 text-slate-200 text-sm">
                  <li className="flex items-start gap-2">
                    <span className="mt-0.5 inline-flex w-5 h-5 items-center justify-center rounded-full bg-purple-500/20 text-purple-300 text-[11px] font-bold">1</span>
                    <span>اذهب إلى طاولتك {tableNumber ? `رقم ${tableNumber}` : 'عند التخصيص'}</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <span className="mt-0.5 inline-flex w-5 h-5 items-center justify-center rounded-full bg-blue-500/20 text-blue-300 text-[11px] font-bold">2</span>
                    <span>تعرف على مجموعتك (٣–٥ أشخاص) وابدأوا بالتعارف</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <span className="mt-0.5 inline-flex w-5 h-5 items-center justify-center rounded-full bg-green-500/20 text-green-300 text-[11px] font-bold">3</span>
                    <span>اختروا نشاطاً من القائمة وابدأوا</span>
                  </li>
                </ul>
                <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-500/10 border border-amber-400/20 text-amber-100 text-xs">
                  <Clock className="w-4 h-4" />
                  <span>بعد الأنشطة الجماعية تبدأ جلسات 1-ل-1 لمدة 30 دقيقة على الأقل</span>
                </div>
              </div>

              {/* Action button */}
              <button
                onClick={() => { localStorage.setItem('blindmatch_group_guide_seen', 'true'); setShowGroupGuide(false); }}
                className="w-full py-2.5 rounded-xl bg-gradient-to-r from-purple-600 to-pink-700 hover:from-purple-700 hover:to-pink-800 text-white font-semibold text-sm shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02]"
              >
                <span className="flex items-center justify-center gap-2">
                  فهمت، لنبدأ!
                  <Rocket className="w-5 h-5" />
                </span>
              </button>
            </div>
          </div>
        )}

        <div className="relative min-h-screen overflow-hidden" dir="rtl">
          {/* Animated gradient + orbs background (match PhoneEntry) */}
          <div className="absolute inset-0 z-0 bg-gradient-to-br from-slate-950 via-indigo-950 to-violet-950 animate-bg-pan" />
          <div className="pointer-events-none absolute inset-0 z-0">
            <div className="absolute -top-28 -left-28 w-[560px] h-[560px] rounded-full bg-gradient-to-br from-orange-400 via-pink-500 to-pink-600 blur-3xl opacity-60 animate-orb mix-blend-screen" />
            <div className="absolute -bottom-32 -right-24 w-[620px] h-[620px] rounded-full bg-gradient-to-br from-blue-600 via-indigo-700 to-indigo-900 blur-3xl opacity-60 animate-orb-alt mix-blend-screen" />
            <div className="absolute inset-0 grain-overlay opacity-[0.05]" />
          </div>
        <div ref={preGameRef} className="relative z-10 max-w-md mx-auto px-4 py-6">
          {/* Enhanced Mobile-First Header with Animations */}
          <div className="text-center mb-6 animate-in fade-in duration-500">
            <div className="relative inline-block mb-4 animate-in zoom-in duration-500" style={{animationDelay: '200ms'}}>
              <div className="w-24 h-24 mx-auto rounded-3xl bg-gradient-to-br from-cyan-500 via-blue-500 to-purple-600 flex items-center justify-center shadow-2xl animate-pulse">
                <Users className="w-12 h-12 text-white" />
              </div>
              <div className="absolute -top-2 -right-2 w-8 h-8 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center shadow-lg animate-bounce">
                <Sparkles className="w-4 h-4 text-white" />
              </div>
              {/* Decorative rings */}
              <div className="absolute inset-0 rounded-3xl border-2 border-cyan-400/30 animate-ping" style={{animationDuration: '2s'}}></div>
            </div>
            <h1 className="text-4xl font-bold text-white mb-3 leading-tight animate-in slide-in-from-top duration-500" style={{animationDelay: '300ms'}}>
              ألعاب جماعية
            </h1>
            <p className="text-slate-300 text-lg animate-in slide-in-from-top duration-500" style={{animationDelay: '400ms'}}>
              45 دقيقة من المرح والتفاعل
            </p>
            <div className="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-cyan-500/20 border border-cyan-500/30 animate-in zoom-in duration-500" style={{animationDelay: '500ms'}}>
              <Clock className="w-4 h-4 text-cyan-400" />
              <span className="text-cyan-300 text-sm font-medium">جلسة واحدة • 7 ألعاب</span>
            </div>
          </div>

          {/* Navigation Bar - Similar to main page */}
          {dataLoaded && participantName && participantNumber && (
            <div className="mb-6">
              <div className="bg-gradient-to-r from-slate-800/40 to-slate-700/40 rounded-full px-4 py-3 border border-slate-600/50 shadow-md backdrop-blur-sm">
                <div className="flex items-center justify-between">
                  {/* Logo */}
                  <div 
                    onClick={() => window.location.href = "/welcome"}
                    className="cursor-pointer transition-all duration-200 hover:opacity-80"
                  >
                    <img 
                      src={logoPng} 
                      alt="BlindMatch" 
                      className="w-10 h-10 sm:w-12 sm:h-12 md:w-14 md:h-14 object-contain" 
                    />
                  </div>

                  {/* Participant Info */}
                  <div className="flex items-center gap-3">
                    <div className="flex items-center gap-1.5">
                      <div className="bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent font-bold text-sm">
                        #{participantNumber}
                      </div>
                      <span className="text-white/90 text-sm font-medium">
                        {participantName}
                      </span>
                    </div>

                    {/* Table Number */}
                    {(tableNumber !== null && tableNumber !== undefined) && (
                      <>
                        <div className="w-px h-4 bg-slate-600"></div>
                        <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 border border-green-400/30 rounded-full px-3 py-1.5 text-xs font-medium text-green-300 flex items-center gap-1.5">
                          <Target className="w-3 h-3" />
                          <span>طاولة {tableNumber}</span>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Enhanced Instructions Card with Professional Design */}
          <div className="mb-6 animate-in slide-in-from-bottom duration-500" style={{animationDelay: '600ms'}}>
            <div className="bg-slate-800/60 backdrop-blur-xl border border-slate-700/50 rounded-2xl overflow-hidden shadow-2xl">
              <div className="bg-gradient-to-r from-cyan-500/20 via-blue-500/20 to-purple-500/20 p-5 border-b border-slate-600/50">
                <h2 className="text-xl font-bold text-white flex items-center justify-center gap-2">
                  <BookOpen className="w-6 h-6 text-cyan-400" />
                  كيف نلعب؟
                </h2>
              </div>
              <div className="p-5 space-y-4">
                {/* Enhanced Steps with Icons */}
                <div className="space-y-3">
                  {[
                    { icon: <Users className="w-4 h-4" />, text: "اجلسوا في دائرة واختاروا من يبدأ", color: "from-cyan-500 to-blue-500" },
                    { icon: <Sparkles className="w-4 h-4" />, text: "اتبعوا قواعد كل لعبة واستمتعوا", color: "from-purple-500 to-pink-500" },
                    { icon: <Trophy className="w-4 h-4" />, text: "احترموا بعضكم واستمعوا بإنصات", color: "from-emerald-500 to-teal-500" }
                  ].map((step, index) => (
                    <div 
                      key={index}
                      className="flex items-start gap-3 bg-slate-700/40 rounded-xl p-4 border border-slate-600/30 hover:border-cyan-500/50 transition-all duration-300 hover:scale-[1.02]"
                    >
                      <div className={`w-10 h-10 rounded-xl bg-gradient-to-r ${step.color} flex items-center justify-center text-white shadow-lg shrink-0`}>
                        {step.icon}
                      </div>
                      <div className="flex-1 pt-1.5">
                        <p className="text-white text-sm font-medium leading-relaxed">{step.text}</p>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Enhanced Timer Info with Pulse Animation */}
                <div className="relative bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border-2 border-cyan-400/40 rounded-xl p-4 mt-5 overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-cyan-400/0 via-cyan-400/10 to-cyan-400/0 animate-pulse"></div>
                  <div className="relative flex items-center justify-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-cyan-500/30 flex items-center justify-center animate-pulse">
                      <Clock className="w-5 h-5 text-cyan-300" />
                    </div>
                    <div className="text-center">
                      <p className="text-cyan-100 font-bold text-base">45 دقيقة للأنشطة</p>
                      <p className="text-cyan-300/80 text-xs">ثم تبدأ الجولات الفردية</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Enhanced Games Preview with Professional Grid */}
          <div className="mb-6 animate-in slide-in-from-bottom duration-500" style={{animationDelay: '700ms'}}>
            <div className="bg-slate-800/60 backdrop-blur-xl border border-slate-700/50 rounded-2xl overflow-hidden shadow-2xl">
              <div className="bg-gradient-to-r from-purple-500/20 via-pink-500/20 to-rose-500/20 p-5 border-b border-slate-600/50">
                <h2 className="text-xl font-bold text-white flex items-center justify-center gap-2">
                  <Sparkles className="w-6 h-6 text-purple-400" />
                  الألعاب المتاحة
                </h2>
                <p className="text-center text-slate-300 text-xs mt-2">7 ألعاب متنوعة ومبتكرة</p>
              </div>
              <div className="p-5 grid grid-cols-2 gap-4">
                {games.map((game, index) => (
                  <div 
                    key={game.id} 
                    onClick={() => {
                      // Start session and directly select this game
                      setGameStarted(true);
                      setTimerActive(true);
                      startGame(game.id);
                    }}
                    className="group relative bg-gradient-to-br from-slate-700/60 to-slate-800/60 rounded-2xl p-4 text-center cursor-pointer transition-all duration-300 hover:from-slate-700 hover:to-slate-800 hover:scale-105 active:scale-95 shadow-lg hover:shadow-2xl border border-slate-600/30 hover:border-cyan-500/50 overflow-hidden"
                  >
                    {/* Hover glow effect */}
                    <div className={`absolute inset-0 bg-gradient-to-br ${game.color} opacity-0 group-hover:opacity-10 transition-opacity duration-300`}></div>
                    
                    <div className="relative z-10">
                      <div className={`w-14 h-14 mx-auto mb-3 rounded-2xl bg-gradient-to-br ${game.color} flex items-center justify-center text-white shadow-xl transition-all duration-300 group-hover:scale-110 group-hover:rotate-6`}>
                        {game.icon}
                      </div>
                      <h3 className="text-white font-bold text-sm mb-2 leading-tight group-hover:text-cyan-300 transition-colors">{game.nameAr}</h3>
                      <div className="flex items-center justify-center gap-1.5 text-slate-400 text-xs">
                        <Clock className="w-3 h-3" />
                        <span>{game.duration} دقائق</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Enhanced Action Buttons with Professional Styling */}
          <div className="space-y-4 mt-8 animate-in slide-in-from-bottom duration-500" style={{animationDelay: '800ms'}}>
            <Button 
              onClick={startSession}
              className="w-full bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 hover:from-cyan-600 hover:via-blue-600 hover:to-purple-700 text-white py-6 text-xl font-bold rounded-2xl shadow-2xl hover:shadow-cyan-500/30 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] relative overflow-hidden group"
            >
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
              <span className="relative flex items-center justify-center gap-3">
                <Play className="w-7 h-7" />
                ابدأ الجلسة الآن
              </span>
            </Button>
            
            <Button 
              onClick={() => window.location.href = "/welcome"}
              variant="outline"
              className="w-full bg-slate-800/50 border-2 border-slate-600 text-slate-300 hover:bg-slate-700/50 hover:border-cyan-500/50 hover:text-white py-4 rounded-xl transition-all duration-300 hover:scale-[1.01] active:scale-[0.99] shadow-lg"
            >
              <Home className="w-5 h-5 ml-2" />
              العودة للشاشة الرئيسية
            </Button>
          </div>
        </div>
      </div>
      </>
    );
  }

  return (
    <>
      {/* Prompt Topics Modal - Available in both pre-game and during-game */}
      <PromptTopicsModal
        open={showPromptTopicsModal}
        onClose={() => setShowPromptTopicsModal(false)}
      />
      {showOnboarding && (
        <OnboardingModal
          isOpen={showOnboarding}
          onClose={() => setShowOnboarding(false)}
          groupMembers={groupMembers}
          tableNumber={tableNumber}
        />
      )}

      <div className="relative min-h-screen overflow-hidden" dir="rtl">
      {/* Animated gradient + orbs background (match PhoneEntry) */}
      <div className="absolute inset-0 z-0 bg-gradient-to-br from-slate-950 via-indigo-950 to-violet-950 animate-bg-pan" />
      <div className="pointer-events-none absolute inset-0 z-0">
        <div className="absolute -top-28 -left-28 w-[560px] h-[560px] rounded-full bg-gradient-to-br from-orange-400 via-pink-500 to-pink-600 blur-3xl opacity-60 animate-orb mix-blend-screen" />
        <div className="absolute -bottom-32 -right-24 w-[620px] h-[620px] rounded-full bg-gradient-to-br from-blue-600 via-indigo-700 to-indigo-900 blur-3xl opacity-60 animate-orb-alt mix-blend-screen" />
        <div className="absolute inset-0 grain-overlay opacity-[0.05]" />
      </div>
      <div className="relative z-10 max-w-md mx-auto px-4 py-4">
        {/* Professional Sticky Header with Glassmorphism (collapsible) */}
        <div className={`sticky top-0 z-40 ${headerCollapsed ? 'bg-transparent border-transparent backdrop-blur-0 shadow-none mb-2 p-1.5' : 'bg-gradient-to-br from-slate-900/95 via-slate-800/95 to-slate-900/95 backdrop-blur-xl border border-slate-700/50 shadow-2xl mb-4 p-4'} rounded-3xl animate-in slide-in-from-top duration-300 transition-all`}>
          {!headerCollapsed && (
          <div className={"relative flex items-center justify-center mb-4"}>
            {/* Logo with hover effect - centered */}
            <button 
              onClick={() => window.location.href = "/welcome"}
              className="flex-shrink-0 transition-transform duration-200 hover:scale-110 active:scale-95"
            >
              <img 
                src={logoPng} 
                alt="BlindMatch" 
                className={`${headerCollapsed ? 'w-8 h-8' : 'w-10 h-10'} object-contain drop-shadow-lg`} 
              />
            </button>

            {/* Back Button with smooth transition - positioned absolutely on left (only when expanded) */}
            {selectedGameId && !headerCollapsed && (
              <button
                onClick={() => {
                  setSelectedGameId(null);
                  setGamePhase('intro');
                }}
                className="absolute left-0 flex items-center gap-1.5 px-4 py-2 rounded-xl bg-slate-700/50 border border-slate-600/50 hover:border-cyan-400/50 hover:bg-cyan-400/10 transition-all duration-200 text-slate-300 hover:text-cyan-300 text-sm font-medium shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95"
              >
                <ChevronLeft className="w-4 h-4" />
                <span>عودة</span>
              </button>
            )}
          </div>
          )}

          {/* Header content */}
          {headerCollapsed ? (
            // Single sleek row when collapsed
            <div className="flex items-center justify-between gap-2 min-h-[44px]">
              {/* Back (compact) */}
              {selectedGameId ? (
                <button
                  onClick={() => { setSelectedGameId(null); setGamePhase('intro'); }}
                  className="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-slate-700/40 border border-slate-600/50 hover:border-cyan-400/50 hover:bg-cyan-400/10 text-slate-300 hover:text-cyan-300 transition-all"
                  aria-label="عودة"
                  title="عودة"
                >
                  <ChevronLeft className="w-4 h-4" />
                </button>
              ) : (
                <span className="w-9" />
              )}

              {/* Center cluster: timer + current game badge */}
              <div className="flex items-center gap-2 flex-1 min-w-0 justify-center">
                <div className={`inline-flex items-center rounded-full px-3.5 py-1 bg-white/5 backdrop-blur-sm shadow-sm ring-1 ring-white/5 transition-colors ${
                  timeRemaining <= 300 ? 'text-red-100' :
                  timeRemaining <= 600 ? 'text-amber-100' :
                  'text-emerald-100'
                }`}>
                  <span className="text-sm font-semibold tabular-nums tracking-tight">{formatTime(timeRemaining)}</span>
                </div>

                {selectedGameId && (
                  <div className={`inline-flex items-center bg-white/5 backdrop-blur-sm rounded-full py-1 px-3 ring-1 ring-white/5 shadow-sm max-w-[55%] overflow-hidden`}>
                    <span className="text-sm text-white/90 font-semibold truncate tracking-tight" title={games.find(g => g.id === selectedGameId)?.nameAr}>
                      {games.find(g => g.id === selectedGameId)?.nameAr}
                    </span>
                  </div>
                )}
              </div>

              {/* Help (compact) */}
              <button
                onClick={() => { setShowHowToModal(true); setHowToSlide(0); }}
                className="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white transition-all"
                aria-label="شرح الدخول للجولة الفردية"
                title="شرح الدخول للجولة الفردية"
              >
                <HelpCircle className="w-4 h-4" />
              </button>
            </div>
          ) : (
            // Expanded stacked content
            <div className={`space-y-3 transition-all`}>
              {/* Elegant Timer Display */}
              <div className="relative">
                <div className={`flex flex-col items-center justify-center gap-1 rounded-2xl py-4 px-6 transition-all duration-500 ${
                  timeRemaining <= 300 ? 'bg-gradient-to-br from-red-500/10 via-red-500/5 to-transparent' : 
                  timeRemaining <= 600 ? 'bg-gradient-to-br from-amber-500/10 via-amber-500/5 to-transparent' : 
                  'bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-transparent'
                }`}>
                  <div className="flex items-baseline gap-1">
                    <span className={`text-4xl font-light tabular-nums tracking-tight ${
                      timeRemaining <= 300 ? 'text-red-400' : 
                      timeRemaining <= 600 ? 'text-amber-400' : 
                      'text-emerald-400'
                    }`}>
                      {formatTime(timeRemaining)}
                    </span>
                  </div>
                  <div className="flex items-center gap-1.5 mt-1">
                    <Clock className={`w-3.5 h-3.5 ${
                      timeRemaining <= 300 ? 'text-red-400/60' : 
                      timeRemaining <= 600 ? 'text-amber-400/60' : 
                      'text-emerald-400/60'
                    }`} />
                    <span className={`text-xs font-medium ${
                      timeRemaining <= 300 ? 'text-red-400/80' : 
                      timeRemaining <= 600 ? 'text-amber-400/80' : 
                      'text-emerald-400/80'
                    }`}>
                      {timeRemaining <= 300 ? 'انتهى الوقت قريباً!' : timeRemaining <= 600 ? 'الوقت ينفد' : 'الوقت المتبقي'}
                    </span>
                  </div>
                </div>
              </div>

              {/* How-To button */}
              <div className="flex flex-col items-center justify-center">
                <button
                  onClick={() => { setShowHowToModal(true); setHowToSlide(0); }}
                  className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-lg hover:shadow-xl transition-all duration-200 text-sm"
                  title="اضغط بعد انتهاء وقت الأنشطة"
                >
                  <HelpCircle className="w-4 h-4" />
                  <span className="font-semibold">شرح الدخول للجولة الفردية</span>
                </button>
                <span className="mt-1 text-[11px] text-white/70">اضغط بعد انتهاء وقت الأنشطة الجماعية</span>
              </div>

              {/* Current Game Badge - Themed */}
              {selectedGameId && (
                <div className={`flex items-center justify-center gap-2 bg-white/5 backdrop-blur-sm rounded-full py-2 px-4 border ${(gameThemes[(selectedGameId as string)] || gameThemes.default).cardBorder} transition-all`}>
                  <div className={`w-5 h-5 rounded-lg bg-gradient-to-r ${games.find(g => g.id === selectedGameId)?.color} flex items-center justify-center text-white shadow-lg ${(gameThemes[(selectedGameId as string)] || gameThemes.default).iconRing}`}>
                    {games.find(g => g.id === selectedGameId)?.icon}
                  </div>
                  <span className="text-sm font-medium text-white/90">
                    {games.find(g => g.id === selectedGameId)?.nameAr}
                  </span>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Mobile Game Content */}
        <div className="bg-slate-800/40 backdrop-blur-sm border border-slate-600/50 rounded-2xl p-4 shadow-xl overflow-hidden">
          {renderGameContent()}
        </div>

      </div>

      {/* Time Up Modal */}
      {showTimeUpModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 border border-white/20 rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-red-500 to-orange-500 flex items-center justify-center">
              <Clock className="w-10 h-10 text-white" />
            </div>
            <h2 className="text-3xl font-bold text-white mb-4">انتهى الوقت!</h2>
            <p className="text-xl text-slate-300 mb-6">حان وقت الجولة الأولى</p>
            <p className="text-slate-400 mb-8">شكراً لكم على المشاركة الرائعة في الألعاب الجماعية</p>
            <Button 
              onClick={() => {
                setShowTimeUpModal(false);
                // You can add navigation to round 1 here
                window.location.href = "/";
              }}
              className="bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white px-8 py-3 text-lg w-full"
            >
              انتقل للجولة الأولى
            </Button>
          </div>
        </div>
      )}

      {/* How-To Tutorial Modal (slideshow) */}
      {showHowToModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div dir="rtl" className="relative w-full max-w-lg bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-5 py-4 border-b border-white/10">
              <div className="flex items-center gap-2 text-white">
                <HelpCircle className="w-5 h-5 text-emerald-400" />
                <h3 className="text-lg font-bold">شرح الدخول للجولة الفردية</h3>
              </div>
              <button onClick={() => setShowHowToModal(false)} className="text-slate-300 hover:text-white">
                <XCircle className="w-5 h-5" />
              </button>
            </div>

            {/* Slide content */}
            <div className="px-5 py-4">
              {howToSlide === 0 && (
                <div className="space-y-4">
                  <h4 className="text-white text-base font-semibold">1) افتح تطبيق واتساب وابحث عن رسالة التأكيد</h4>
                  <p className="text-slate-300 text-sm">افتح المحادثة التي وصلتك من المنظم، وتأكد من وجود بياناتك مع الرابط.</p>
                  <div className="rounded-xl overflow-hidden border border-slate-700/60 shadow-lg bg-slate-900/40 flex items-center justify-center">
                    <img
                      src="/example1.jpg"
                      alt="مثال رسالة واتساب"
                      loading="lazy"
                      className="w-full max-h-[60vh] object-contain"
                    />
                  </div>
                  <p className="text-slate-400 text-xs text-center">مثال رسالة واتساب تحتوي على رقمك والرمز والرابط</p>
                </div>
              )}

              {howToSlide === 1 && (
                <div className="space-y-4">
                  <h4 className="text-white text-base font-semibold">2) اعثر على رابط حسابك</h4>
                  <p className="text-slate-300 text-sm">ستجد في الرسالة رابط الدخول لحسابك. احتفظ به، ستحتاجه للجولة الفردية.</p>
                  <div className="rounded-xl overflow-hidden border border-slate-700/60 shadow-lg bg-slate-900/40 flex items-center justify-center">
                    <img
                      src="/example2.jpg"
                      alt="مثال رابط الحساب"
                      loading="lazy"
                      className="w-full max-h-[60vh] object-contain"
                    />
                  </div>
                  <p className="text-slate-400 text-xs text-center">مثال رسالة تحتوي على رابط حسابك للدخول للجولة الفردية</p>
                </div>
              )}

              {howToSlide === 2 && (
                <div className="space-y-4">
                  <h4 className="text-white text-base font-semibold">3) متى يشتغل الرابط؟</h4>
                  <p className="text-slate-300 text-sm">لن يعمل الرابط إلا بعد إعلان المنظم أن وقت الأنشطة الجماعية انتهى وبدء الجولات الفردية. عندها اضغط الرابط وسجّل دخولك.</p>
                  <ul className="list-disc pr-5 text-slate-300 text-sm space-y-1">
                    <li className="marker:text-emerald-400">تأكد أن اتصال الإنترنت يعمل</li>
                    <li className="marker:text-emerald-400">افتح الرابط من رسالة الواتساب مباشرة</li>
                    <li className="marker:text-emerald-400">ابقَ على الصفحة للحصول على التعليمات</li>
                  </ul>
                </div>
              )}

              {/* Controls */}
              <div className="mt-6 flex items-center justify-between">
                <button
                  onClick={() => setHowToSlide((s) => Math.max(0, s - 1))}
                  disabled={howToSlide === 0}
                  className="px-3 py-2 rounded-lg border border-slate-600 text-slate-200 disabled:opacity-40 hover:bg-slate-700/40 flex items-center gap-1"
                >
                  <ChevronRight className="w-4 h-4 rotate-180" />
                  السابق
                </button>
                <div className="flex items-center gap-2">
                  {[0,1,2].map((i) => (
                    <span key={i} className={`w-2 h-2 rounded-full ${howToSlide===i ? 'bg-emerald-400' : 'bg-slate-600'}`}></span>
                  ))}
                </div>
                {howToSlide < 2 ? (
                  <button
                    onClick={() => setHowToSlide((s) => Math.min(2, s + 1))}
                    className="px-3 py-2 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white flex items-center gap-1"
                  >
                    التالي
                    <ChevronRight className="w-4 h-4" />
                  </button>
                ) : (
                  <button
                    onClick={() => setShowHowToModal(false)}
                    className="px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white"
                  >
                    تم
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Individual Rounds Preparation Modal */}
      {showIndividualRoundsModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-gradient-to-br from-slate-900 to-slate-800 border-2 border-cyan-400/50 rounded-2xl p-8 max-w-md w-full shadow-2xl animate-in zoom-in-95 duration-300">
            {/* Icon */}
            <div className="flex justify-center mb-6">
              <div className="w-20 h-20 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center animate-pulse">
                <Smartphone className="w-10 h-10 text-white" />
              </div>
            </div>

            {/* Title */}
            <h3 className="text-2xl font-bold text-center mb-4 text-white">
              استعد للجولات الفردية
            </h3>

            {/* Instructions */}
            <div className="space-y-4 mb-6">
              <div className="flex items-start gap-3 p-4 bg-cyan-500/10 border border-cyan-400/30 rounded-xl">
                <LinkIcon className="w-6 h-6 text-cyan-400 flex-shrink-0 mt-1" />
                <div>
                  <p className="text-cyan-100 font-semibold mb-1">
                    افتح رابط الواتساب
                  </p>
                  <p className="text-slate-300 text-sm">
                    افتح الرابط الذي أرسلناه لك عبر الواتساب للدخول إلى الجولات الفردية
                  </p>
                </div>
              </div>

              <div className="flex items-start gap-3 p-4 bg-blue-500/10 border border-blue-400/30 rounded-xl">
                <Smartphone className="w-6 h-6 text-blue-400 flex-shrink-0 mt-1" />
                <div>
                  <p className="text-blue-100 font-semibold mb-1">
                    ابقِ هاتفك مفتوحاً
                  </p>
                  <p className="text-slate-300 text-sm">
                    احتفظ بهاتفك مفتوحاً ومشحوناً للحصول على التحديثات الفورية
                  </p>
                </div>
              </div>

              <div className="flex items-start gap-3 p-4 bg-purple-500/10 border border-purple-400/30 rounded-xl">
                <Bell className="w-6 h-6 text-purple-400 flex-shrink-0 mt-1" />
                <div>
                  <p className="text-purple-100 font-semibold mb-1">
                    كن جاهزاً للمطابقة
                  </p>
                  <p className="text-slate-300 text-sm">
                    ستبدأ الجولات الفردية قريباً - تأكد من جاهزيتك!
                  </p>
                </div>
              </div>
            </div>

            {/* Close Button */}
            <Button
              onClick={() => setShowIndividualRoundsModal(false)}
              className="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-3 text-lg"
            >
              فهمت
            </Button>
          </div>
        </div>
      )}
      </div>
    </>
  );
}
